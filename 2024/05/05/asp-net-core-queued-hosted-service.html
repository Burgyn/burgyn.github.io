<!DOCTYPE html>
<html lang="en" class="colors theme-dark-2 entities fonts code-style"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">

    <!-- cache -->
    <meta http-equiv="Cache-Control" content="max-age=86400, must-revalidate" />    

    <!-- Pridanie Slick Carousel CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <!-- Pridanie Slick Carousel Theme CSS (voliteƒæn√©) -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <!-- Pridanie jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Pridanie Lightbox CSS a JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js"></script>
    <!-- Pridanie Slick Carousel JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

    <!-- IMPORTANT -->
    <script src="https://use.fontawesome.com/ee196462b9.js"></script>

    <!-- keywoards -->
    
    <meta name="keywords" content="ASP.NET Core, AZURE, AWS, Service bus, AZURE Functions, task queue, background task, IBackgroundTaskQueue, System.Threading.Channel, background service, job queue, Hangfire">
    

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FYN9BGS01R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FYN9BGS01R');
    </script>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ASP.NET Core - Queued hosted service | Burgyn‚Äôs blog</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="ASP.NET Core - Queued hosted service" />
<meta name="author" content="Milan Martiniak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Discover how to process long-running actions with ASP.NET Core by task queuing, simultaneously improving your application‚Äôs performance." />
<meta property="og:description" content="Discover how to process long-running actions with ASP.NET Core by task queuing, simultaneously improving your application‚Äôs performance." />
<link rel="canonical" href="https://blog.burgyn.online/2024/05/05/asp-net-core-queued-hosted-service" />
<meta property="og:url" content="https://blog.burgyn.online/2024/05/05/asp-net-core-queued-hosted-service" />
<meta property="og:site_name" content="Burgyn‚Äôs blog" />
<meta property="og:image" content="https://blog.burgyn.online/assets/images/code_images/asp-net-core-queued-hosted-service/cover.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-05T17:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://blog.burgyn.online/assets/images/code_images/asp-net-core-queued-hosted-service/cover.png" />
<meta property="twitter:title" content="ASP.NET Core - Queued hosted service" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Milan Martiniak","url":"https://burgyn.bio.link/"},"dateModified":"2024-05-05T17:00:00+00:00","datePublished":"2024-05-05T17:00:00+00:00","description":"Discover how to process long-running actions with ASP.NET Core by task queuing, simultaneously improving your application‚Äôs performance.","headline":"ASP.NET Core - Queued hosted service","image":"https://blog.burgyn.online/assets/images/code_images/asp-net-core-queued-hosted-service/cover.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.burgyn.online/2024/05/05/asp-net-core-queued-hosted-service"},"url":"https://blog.burgyn.online/2024/05/05/asp-net-core-queued-hosted-service"}</script>
<!-- End Jekyll SEO tag -->


    


    <!-- CSS -->
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-192x192" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-512x512" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">

    <!-- PWA -->
    <link rel="manifest" href="/assets/manifest.json">

    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="https://blog.burgyn.online/feed.xml" title="Burgyn's blog" />

    <!-- Google Analytics-->
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'dark'
        });
    </script>
</head><body>
    <svg width="0" height="0">
        <defs>
            <marker id="custom-arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
            <path d="M0,0 L0,7 L10,3.5 z"></path>
            </marker>
        </defs>
    </svg>
    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <div class="site-name">
        <img src="/assets/android-chrome-192x192.png" alt="Burgyn's logo" class="nav-logo">
        <h2 class="nav-title">Burgyn's blog</h2>
      </div>
    </a>    
    <ul>
      <li><a href="/">Posts</a></li>
      <li><a href="/about/">About me</a></li>
    </ul>
  </div>
</nav>

    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline"><p>ASP.NET Core - Queued hosted service</p>
</h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2024-05-05T17:00:00+00:00" itemprop="datePublished">May 5, 2024
            </time><span itemprop="author" itemscope
                itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name"> | Milan Martiniak</span></span>
            | <span class="fa fa-tags" aria-label="Tags"> </span> 
            <span>
                <!-- <a href="/tags/csharp">csharp</a> -->
                csharp, 
            </span> 
            <span>
                <!-- <a href="/tags/dotnet">dotnet</a> -->
                dotnet, 
            </span> 
            <span>
                <!-- <a href="/tags/asp.net core">asp.net core</a> -->
                asp.net core, 
            </span> 
            <span>
                <!-- <a href="/tags/AZURE">AZURE</a> -->
                AZURE
            </span>  
        </p>
    </header>

    
    <div class="post-thumbnail">
        <img src="/assets/images/code_images/asp-net-core-queued-hosted-service/cover.png" alt="ASP.NET Core - Queued hosted service" itemprop="image">
    </div>
    

    <div class="post-content e-content" itemprop="articleBody">
        <blockquote>
  <p>‚ÑπÔ∏è This is a follow-up to <a href="/2024/04/28/asp-net-core-periodic-background-task">ASP.NET Core - Periodic Background Task</a>.</p>
</blockquote>

<p>There are situations when you do not want to process a longer-running action directly during request processing, but want to queue it and have it processed later. This is very useful when processing a large number of requests, where processing them directly (or parts of them) could slow down the overall performance of the application. If you use cloud services like AZURE or AWS, you may want to reach for their solutions. In AZURE, this would likely be a combination of <a href="https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview">Service bus</a> and <a href="https://azure.microsoft.com/en-us/products/functions#:~:text=Azure%20Functions%20is%20an%20event,highest%20level%20of%20hardware%20abstraction.">AZURE Functions</a>.</p>

<p>But it‚Äôs good to know that we can implement a similar solution directly in our ASP.NET Core service.</p>

<p>Let‚Äôs define an interface describing a simple task queue:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// üëá Simple interface for background task queue</span>
<span class="k">public</span> <span class="k">interface</span> <span class="nc">IBackgroundTaskQueue</span>
<span class="p">{</span>
    <span class="n">ValueTask</span> <span class="nf">Queue</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">,</span> <span class="n">ValueTask</span><span class="p">&gt;</span> <span class="n">workItem</span><span class="p">);</span>

    <span class="n">ValueTask</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">,</span> <span class="n">ValueTask</span><span class="p">&gt;&gt;</span> <span class="nf">Dequeue</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For example, a task queue implementation based on <code class="highlighter-rouge">System.Threading.Channel</code> might look like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// üëá Simple implementation of background task queue based on System.Threading.Channel</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">BackgroundTaskQueue</span> <span class="p">:</span> <span class="n">IBackgroundTaskQueue</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Channel</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">,</span> <span class="n">ValueTask</span><span class="p">&gt;&gt;</span> <span class="n">_queue</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">BackgroundTaskQueue</span><span class="p">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BoundedChannelOptions</span><span class="p">(</span><span class="n">capacity</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// üëá Wait for the queue to have space</span>
            <span class="n">FullMode</span> <span class="p">=</span> <span class="n">BoundedChannelFullMode</span><span class="p">.</span><span class="n">Wait</span>
        <span class="p">};</span>
        <span class="n">_queue</span> <span class="p">=</span> <span class="n">Channel</span><span class="p">.</span><span class="n">CreateBounded</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">,</span> <span class="n">ValueTask</span><span class="p">&gt;&gt;(</span><span class="n">options</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">ValueTask</span> <span class="nf">Queue</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">,</span> <span class="n">ValueTask</span><span class="p">&gt;</span> <span class="n">workItem</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ArgumentNullException</span><span class="p">.</span><span class="nf">ThrowIfNull</span><span class="p">(</span><span class="n">workItem</span><span class="p">);</span>

        <span class="k">await</span> <span class="n">_queue</span><span class="p">.</span><span class="n">Writer</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="n">workItem</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">,</span> <span class="n">ValueTask</span><span class="p">&gt;&gt;</span> <span class="nf">Dequeue</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">workItem</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_queue</span><span class="p">.</span><span class="n">Reader</span><span class="p">.</span><span class="nf">ReadAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">workItem</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, let‚Äôs create a background service that will sequentially process tasks from the queue:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// üëá Hosted service that processes the queued work items</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">QueuedHostedService</span><span class="p">(</span>
    <span class="n">IBackgroundTaskQueue</span> <span class="n">taskQueue</span><span class="p">,</span>
    <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">QueuedHostedService</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span> <span class="p">:</span> <span class="n">BackgroundService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">QueuedHostedService</span><span class="p">&gt;</span> <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IBackgroundTaskQueue</span> <span class="n">_taskQueue</span> <span class="p">=</span> <span class="n">taskQueue</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ExecuteAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">stoppingToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(!</span><span class="n">stoppingToken</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// üëá Dequeue the work item</span>
            <span class="kt">var</span> <span class="n">workItem</span> <span class="p">=</span>
                <span class="k">await</span> <span class="n">_taskQueue</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">(</span><span class="n">stoppingToken</span><span class="p">);</span>

            <span class="k">try</span>
            <span class="p">{</span>
                <span class="c1">// üëá Execute the work item</span>
                <span class="k">await</span> <span class="nf">workItem</span><span class="p">(</span><span class="n">stoppingToken</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error occurred executing: {WorkItem}."</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">workItem</span><span class="p">));</span>
                <span class="k">throw</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let‚Äôs not forget to register the service and the job queue in DI containers:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// üëá Register the hosted service and the background task queue in the DI container</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IBackgroundTaskQueue</span><span class="p">&gt;(</span><span class="k">new</span> <span class="nf">BackgroundTaskQueue</span><span class="p">(</span><span class="m">30</span><span class="p">));</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">QueuedHostedService</span><span class="p">&gt;();</span>
</code></pre></div></div>

<p>For example, instead of processing an order directly within an endpoint, the use case might be to place it in a job queue:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// üëá Endpoint for processing orders</span>
<span class="n">app</span><span class="p">.</span><span class="nf">MapPost</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span>
    <span class="n">Order</span> <span class="n">order</span><span class="p">,</span> 
    <span class="p">[</span><span class="n">FromServices</span><span class="p">]</span> <span class="n">IBackgroundTaskQueue</span> <span class="n">backgroundTaskQueue</span><span class="p">,</span> 
    <span class="p">[</span><span class="n">FromServices</span><span class="p">]</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="c1">// üëá Enqueue the work item</span>
    <span class="k">await</span> <span class="n">backgroundTaskQueue</span><span class="p">.</span><span class="nf">Queue</span><span class="p">(</span><span class="k">async</span> <span class="n">token</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// üëá Simulate processing the order</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Processing order: {order}"</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Order processed: {order}"</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="n">Results</span><span class="p">.</span><span class="nf">Created</span><span class="p">(</span><span class="s">$"/orders/</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Id</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>In this way, we have created a simple job queue that processes jobs in the background. This solution is suitable for simple scenarios. For more complex scenarios, for example, you need to persist the jobs so that you can process them in case of an outage. You can use solutions such as Redis, AZURE Storage Account Queues, or a database to store the jobs.</p>

<p>If even this is not enough (you need to store messages because of possible outages), try solutions like <a href="https://www.hangfire.io/">Hangfire</a>, or cloud platform services like AZURE Service Bus + AZURE Functions.</p>

    </div>

    <div class="carousel">
        
    </div>

    <a class="u-url" href="/2024/05/05/asp-net-core-queued-hosted-service" hidden></a>

</article>

            <script data-name="BMC-Widget" data-cfasync="false" 
                src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" 
                data-id="minomartiniak" 
                data-description="Support me on Buy me a coffee!" 
                data-message="" 
                data-color="#00BF63" data-position="Right" 
                data-x_margin="25" 
                data-y_margin="50">
            </script>
        </div>
    </main><footer class="footer">
  <span>
    &copy; <time datetime="2024-08-02 20:28:03 +0000">2024</time> Milan Martiniak
    <a rel="me" href="https://github.com/burgyn"
      title="GitHub - burgyn">
      <span class="fa fa-github" aria-label="GitHub"></span>
    </a>
    <a rel="me" href="https://twitter.com/minomartiniak"
      title="Twitter - minomartiniak">
      <span class="fa fa-twitter" aria-label="Twitter"></span>
    </a>
    <a rel="me" href="https://linkedin.com/in/milanmartiniak" title="LinkedIn - Milan Martiniak">
      <span class="fa fa-linkedin" aria-label="LinkedIn"></span>
    </a>

    <a rel="me" href="https://blog.burgyn.online/feed.xml" title="RSS feed">
      <span class="fa fa-rss" aria-label="RSS"></span>
    </a>
  </span>
</footer><script type="text/javascript">
        $(document).ready(function () {
            $('.carousel').slick({
                dots: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                centerMode: false,
                focusOnSelect: true,
                infinite: false,
                adaptiveHeight: true
            });
        });

        lightbox.option({
            'resizeDuration': 50,
            'wrapAround': false,
            'fadeDuration': 50,
            'imageFadeDuration': 50,
            'resizeDuration': 50            
        })

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>

</html>