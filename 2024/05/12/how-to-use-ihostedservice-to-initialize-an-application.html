<!DOCTYPE html>
<html lang="en" class="colors theme-dark-2 entities fonts code-style"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">

    <!-- cache -->
    <meta http-equiv="Cache-Control" content="max-age=86400, must-revalidate" />    

    <!-- Pridanie Slick Carousel CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <!-- Pridanie Slick Carousel Theme CSS (voliteľné) -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <!-- Pridanie jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Pridanie Lightbox CSS a JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js"></script>
    <!-- Pridanie Slick Carousel JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

    <!-- IMPORTANT -->
    <script src="https://use.fontawesome.com/ee196462b9.js"></script>

    <!-- keywoards -->
    
    <meta name="keywords" content="ASP.NET Core, IHostedService, database migrations, local cache, initialization, service start, IServiceScopeFactory, ProductsDbContext, AppInitializerHandler, Entity Framework, CI/CD process, dotnet ef migrations bundle">
    

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FYN9BGS01R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FYN9BGS01R');
    </script>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>How to use IHostedService to initialize an application | Burgyn’s blog</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="How to use IHostedService to initialize an application" />
<meta name="author" content="Milan Martiniak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn how to use IHostedService in ASP.NET Core for tasks like database migrations or local cache loading before the service starts responding." />
<meta property="og:description" content="Learn how to use IHostedService in ASP.NET Core for tasks like database migrations or local cache loading before the service starts responding." />
<link rel="canonical" href="https://blog.burgyn.online/2024/05/12/how-to-use-ihostedservice-to-initialize-an-application" />
<meta property="og:url" content="https://blog.burgyn.online/2024/05/12/how-to-use-ihostedservice-to-initialize-an-application" />
<meta property="og:site_name" content="Burgyn’s blog" />
<meta property="og:image" content="https://blog.burgyn.online/assets/images/code_images/how-to-use-ihostedservice-to-initialize-an-application/cover.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-12T17:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://blog.burgyn.online/assets/images/code_images/how-to-use-ihostedservice-to-initialize-an-application/cover.png" />
<meta property="twitter:title" content="How to use IHostedService to initialize an application" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Milan Martiniak","url":"https://burgyn.bio.link/"},"dateModified":"2024-05-12T17:00:00+00:00","datePublished":"2024-05-12T17:00:00+00:00","description":"Learn how to use IHostedService in ASP.NET Core for tasks like database migrations or local cache loading before the service starts responding.","headline":"How to use IHostedService to initialize an application","image":"https://blog.burgyn.online/assets/images/code_images/how-to-use-ihostedservice-to-initialize-an-application/cover.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.burgyn.online/2024/05/12/how-to-use-ihostedservice-to-initialize-an-application"},"url":"https://blog.burgyn.online/2024/05/12/how-to-use-ihostedservice-to-initialize-an-application"}</script>
<!-- End Jekyll SEO tag -->


    


    <!-- CSS -->
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-192x192" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-512x512" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">

    <!-- PWA -->
    <link rel="manifest" href="/assets/manifest.json">

    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="https://blog.burgyn.online/feed.xml" title="Burgyn's blog" />

    <!-- Google Analytics-->
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'dark'
        });
    </script>
</head><body>
    <svg width="0" height="0">
        <defs>
            <marker id="custom-arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
            <path d="M0,0 L0,7 L10,3.5 z"></path>
            </marker>
        </defs>
    </svg>
    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <div class="site-name">
        <img src="/assets/android-chrome-192x192.png" alt="Burgyn's logo" class="nav-logo">
        <h2 class="nav-title">Burgyn's blog</h2>
      </div>
    </a>    
    <ul>
      <li><a href="/">Posts</a></li>
      <li><a href="/about/">About me</a></li>
    </ul>
  </div>
</nav>

    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline"><p>How to use IHostedService to initialize an application</p>
</h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2024-05-12T17:00:00+00:00" itemprop="datePublished">May 12, 2024
            </time><span itemprop="author" itemscope
                itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name"> | Milan Martiniak</span></span>
            | <span class="fa fa-tags" aria-label="Tags"> </span> 
            <span>
                <!-- <a href="/tags/csharp">csharp</a> -->
                csharp, 
            </span> 
            <span>
                <!-- <a href="/tags/asp.net core">asp.net core</a> -->
                asp.net core, 
            </span> 
            <span>
                <!-- <a href="/tags/architecture">architecture</a> -->
                architecture
            </span>  
        </p>
    </header>

    
    <div class="post-thumbnail">
        <img src="/assets/images/code_images/how-to-use-ihostedservice-to-initialize-an-application/cover.png" alt="How to use IHostedService to initialize an application" itemprop="image">
    </div>
    

    <div class="post-content e-content" itemprop="articleBody">
        <blockquote>
  <p>ℹ️ This is another article in a series showing how you can use <code class="highlighter-rouge">IHostedService</code>.</p>
  <ul>
    <li><a href="/2024/04/28/asp-net-core-periodic-background-task">ASP.NET Core - Periodic Background Task</a>.</li>
    <li><a href="/2024/05/05/asp-net-core-queued-hosted-service">ASP.NET Core - Queued hosted service</a>.</li>
  </ul>
</blockquote>

<p>You may find that you need to do some initialization before your ASP.NET Core service starts (before the service starts responding to queries). 
For example, you need to run database migrations, create some records, create storage, load data into the local cache, and so on.</p>

<blockquote>
  <p>⚠️ Beware of database migrations and data initialization. 
For a more complex system it is recommended to do this in the CI/CD process and not at service start <em>(complications with multiple service instances, slowing down the application start, …)</em>.<br />
In the case of <a href="https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/applying?tabs=dotnet-core-cli#bundles">Entity Framework it is possible for example to create a bundle.exe</a> <code class="highlighter-rouge">dotnet ef migrations bundle</code> and run this in the CD process.</p>

  <p>However, this is suitable for simple services or for local development needs.</p>
</blockquote>

<p>A simple and quite nice way to do this is to use <code class="highlighter-rouge">IHostedService</code>.</p>

<p>Let’s create an interface for such an application initializer:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IAppInitializer</span>
<span class="p">{</span>
    <span class="n">Task</span> <span class="nf">InitializeAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We then create a handler that implements <code class="highlighter-rouge">IHostedService</code> and handles all the initializers:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="k">class</span> <span class="nc">AppInitializerHandler</span><span class="p">(</span><span class="n">IServiceScopeFactory</span> <span class="n">scopeFactory</span><span class="p">)</span> 
    <span class="p">:</span> <span class="n">IHostedService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceScopeFactory</span> <span class="n">_scopeFactory</span> <span class="p">=</span> <span class="n">scopeFactory</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 👇 Create a new scope to retrieve scoped services</span>
        <span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_scopeFactory</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">();</span>
        <span class="c1">// 👇 Get all initializers</span>
        <span class="kt">var</span> <span class="n">initializers</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetServices</span><span class="p">&lt;</span><span class="n">IAppInitializer</span><span class="p">&gt;();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">initializer</span> <span class="k">in</span> <span class="n">initializers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 👇 Run the initializer (choose your async strategy)</span>
            <span class="k">await</span> <span class="n">initializer</span><span class="p">.</span><span class="nf">InitializeAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>An example of an initializer that will populate the local cache:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CacheInitializer</span><span class="p">(</span>
    <span class="n">IMemoryCache</span> <span class="n">memoryCache</span><span class="p">,</span> 
    <span class="n">IProductRepository</span> <span class="n">productRepository</span><span class="p">)</span> <span class="p">:</span> <span class="n">IAppInitializer</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMemoryCache</span> <span class="n">_memoryCache</span> <span class="p">=</span> <span class="n">memoryCache</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IProductRepository</span> <span class="n">productRepository</span> <span class="p">=</span> <span class="n">productRepository</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="nf">InitializeAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Your logic for initializing the cache can go here</span>
        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In case we want to run database migrations, we can directly implement this interface in DbContext:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductsDbContext</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IAppInitializer</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">Products</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">ProductsDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">InitializeAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 👇 Apply pending migrations</span>
        <span class="k">await</span> <span class="n">Database</span><span class="p">.</span><span class="nf">MigrateAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, we register all initializers and handler in DI containers:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 👇 Register the initializers</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">IAppInitializer</span><span class="p">,</span> <span class="n">ProductsDbContext</span><span class="p">&gt;();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">IAppInitializer</span><span class="p">,</span> <span class="n">CacheInitializer</span><span class="p">&gt;();</span>

<span class="c1">// 👇 register AppInitializerHandler as a hosted service</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">AppInitializerHandler</span><span class="p">&gt;();</span>
</code></pre></div></div>

<p>This way we can elegantly initialize our application before it starts answering queries.</p>

<blockquote>
  <p>⚠️ Remember that initialization should be fast.</p>
</blockquote>

<p>To simplify registration to the DI container, we can create an extension:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ServiceCollectionExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="n">AddAppInitializer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
        <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span> 
        <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">IAppInitializer</span>
    <span class="p">{</span>
        <span class="n">services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">IAppInitializer</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;();</span>
        <span class="k">return</span> <span class="n">services</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 👇 Register the initializers</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddAppInitializer</span><span class="p">&lt;</span><span class="n">ProductsDbContext</span><span class="p">&gt;();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddAppInitializer</span><span class="p">&lt;</span><span class="n">CacheInitializer</span><span class="p">&gt;();</span>
</code></pre></div></div>

    </div>

    <div class="carousel">
        
    </div>

    <a class="u-url" href="/2024/05/12/how-to-use-ihostedservice-to-initialize-an-application" hidden></a>

</article>

            <script data-name="BMC-Widget" data-cfasync="false" 
                src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" 
                data-id="minomartiniak" 
                data-description="Support me on Buy me a coffee!" 
                data-message="" 
                data-color="#00BF63" data-position="Right" 
                data-x_margin="25" 
                data-y_margin="50">
            </script>
        </div>
    </main><footer class="footer">
  <span>
    &copy; <time datetime="2024-10-30 07:44:44 +0000">2024</time> Milan Martiniak
    <a rel="me" href="https://github.com/burgyn"
      title="GitHub - burgyn">
      <span class="fa fa-github" aria-label="GitHub"></span>
    </a>
    <a rel="me" href="https://twitter.com/minomartiniak"
      title="Twitter - minomartiniak">
      <span class="fa fa-twitter" aria-label="Twitter"></span>
    </a>
    <a rel="me" href="https://linkedin.com/in/milanmartiniak" title="LinkedIn - Milan Martiniak">
      <span class="fa fa-linkedin" aria-label="LinkedIn"></span>
    </a>

    <a rel="me" href="https://blog.burgyn.online/feed.xml" title="RSS feed">
      <span class="fa fa-rss" aria-label="RSS"></span>
    </a>
  </span>
</footer><script type="text/javascript">
        $(document).ready(function () {
            $('.carousel').slick({
                dots: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                centerMode: false,
                focusOnSelect: true,
                infinite: false,
                adaptiveHeight: true
            });
        });

        lightbox.option({
            'resizeDuration': 50,
            'wrapAround': false,
            'fadeDuration': 50,
            'imageFadeDuration': 50,
            'resizeDuration': 50            
        })

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>

</html>