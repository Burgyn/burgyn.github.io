<!DOCTYPE html>
<html lang="en" class="colors theme-dark-2 entities fonts code-style"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">

    <!-- cache -->
    <meta http-equiv="Cache-Control" content="max-age=86400, must-revalidate" />    

    <!-- Pridanie Slick Carousel CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <!-- Pridanie Slick Carousel Theme CSS (voliteľné) -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <!-- Pridanie jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Pridanie Lightbox CSS a JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js"></script>
    <!-- Pridanie Slick Carousel JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

    <!-- IMPORTANT -->
    <script src="https://use.fontawesome.com/ee196462b9.js"></script>

    <!-- keywoards -->
    
    <meta name="keywords" content="Azure Service Bus, microservices development, message broker, throttling, topic filters, entity change message, KROS a.s, one subscriber solution">
    

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FYN9BGS01R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FYN9BGS01R');
    </script>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AZURE Service Bus - How we didn’t use Topic filters | Burgyn’s blog</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="AZURE Service Bus - How we didn’t use Topic filters" />
<meta name="author" content="Milan Martiniak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn about throttling with AZURE Service Bus in microservices development, its challenges and possible solutions found by KROS a.s team." />
<meta property="og:description" content="Learn about throttling with AZURE Service Bus in microservices development, its challenges and possible solutions found by KROS a.s team." />
<link rel="canonical" href="https://blog.burgyn.online/2024/03/24/azure-service-bus-how-we-did-not-use-topic-filters" />
<meta property="og:url" content="https://blog.burgyn.online/2024/03/24/azure-service-bus-how-we-did-not-use-topic-filters" />
<meta property="og:site_name" content="Burgyn’s blog" />
<meta property="og:image" content="https://blog.burgyn.online/assets/images/service-bus-topics/cover.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-03-24T17:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://blog.burgyn.online/assets/images/service-bus-topics/cover.png" />
<meta property="twitter:title" content="AZURE Service Bus - How we didn’t use Topic filters" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Milan Martiniak","url":"https://burgyn.bio.link/"},"dateModified":"2024-03-24T17:00:00+00:00","datePublished":"2024-03-24T17:00:00+00:00","description":"Learn about throttling with AZURE Service Bus in microservices development, its challenges and possible solutions found by KROS a.s team.","headline":"AZURE Service Bus - How we didn’t use Topic filters","image":"https://blog.burgyn.online/assets/images/service-bus-topics/cover.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.burgyn.online/2024/03/24/azure-service-bus-how-we-did-not-use-topic-filters"},"url":"https://blog.burgyn.online/2024/03/24/azure-service-bus-how-we-did-not-use-topic-filters"}</script>
<!-- End Jekyll SEO tag -->


    


    <!-- CSS -->
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-192x192" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-512x512" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">

    <!-- PWA -->
    <link rel="manifest" href="/assets/manifest.json">

    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="https://blog.burgyn.online/feed.xml" title="Burgyn's blog" />

    <!-- Google Analytics-->
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'dark'
        });
    </script>
</head><body>
    <svg width="0" height="0">
        <defs>
            <marker id="custom-arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
            <path d="M0,0 L0,7 L10,3.5 z"></path>
            </marker>
        </defs>
    </svg>
    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <div class="site-name">
        <img src="/assets/android-chrome-192x192.png" alt="Burgyn's logo" class="nav-logo">
        <h2 class="nav-title">Burgyn's blog</h2>
      </div>
    </a>    
    <ul>
      <li><a href="/">Posts</a></li>
      <li><a href="/about/">About me</a></li>
    </ul>
  </div>
</nav>

    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline"><p>AZURE Service Bus - How we didn't use Topic filters</p>
</h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2024-03-24T17:00:00+00:00" itemprop="datePublished">Mar 24, 2024
            </time><span itemprop="author" itemscope
                itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name"> | Milan Martiniak</span></span>
            | <span class="fa fa-tags" aria-label="Tags"> </span> 
            <span>
                <!-- <a href="/tags/AZURE">AZURE</a> -->
                AZURE, 
            </span> 
            <span>
                <!-- <a href="/tags/architecture">architecture</a> -->
                architecture, 
            </span> 
            <span>
                <!-- <a href="/tags/csharp">csharp</a> -->
                csharp, 
            </span> 
            <span>
                <!-- <a href="/tags/dotnet">dotnet</a> -->
                dotnet
            </span>  
        </p>
    </header>

    
    <div class="post-thumbnail">
        <img src="/assets/images/service-bus-topics/cover.png" alt="AZURE Service Bus - How we didn't use Topic filters" itemprop="image">
    </div>
    

    <div class="post-content e-content" itemprop="articleBody">
        <p>When developing microservices, you are likely to encounter the need for a message broker. A reliable system for sending messages between services.</p>

<p>We at KROS a.s. have decided to use Azure Service Bus for this purpose, which offers so-called topics within the created namespaces to which you can have multiple subscribers.</p>

<p>Recently we wanted to use its functionality <a href="https://learn.microsoft.com/en-us/azure/service-bus-messaging/topic-filters">Topic filtes</a>. This allows you to have a so-called filter, or rule, on individual subscriptions for a given topic that decides whether a message is delivered to a given subscription.</p>

<p>We wanted to apply this to our use case with search indexing. When we change domain entities in our service, we send an entity change message. We send information about the entity type and the changed properties. The Azure function catches these messages and ensures the changes are indexed into our full text search. We wanted to automate this so we have the whole mechanism in the base class. In our case, it was easiest to send the change messages to one common topic, but we also wanted there to be a separate subscriber for each entity type. Topic filters seemed perfect for this to us. From a design perspective we liked it, the publisher sends to one topic and doesn’t care about more. The subscriber gets the message as it expects and the correct delivery is ensured by the logic on the infrastructure side.</p>

<p>But there was one problem! And that was in the form of throttling. We use Azure Service Bus in Standard tier. The latter, according to <a href="https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-throttling">documentation</a>, uses shared resources. To ensure fair resource usage across all namespaces that use the same environment, Azure uses credit-based throttling. This system limits the number of operations that can be executed at any given time.</p>

<p>At the beginning of that time period (currently one second), Azure allocates a certain number of credits <em>(currently <code class="highlighter-rouge">1000</code>. Thus <code class="highlighter-rouge">1000 credits per second</code>).</em> If the credits run out, then further operations in that time interval will be throttled until the next time period. Credits are replenished after the time period has elapsed.</p>

<p>Basic data operations (<code class="highlighter-rouge">Send</code>, <code class="highlighter-rouge">Receive</code>, <code class="highlighter-rouge">Peek</code> and their <code class="highlighter-rouge">async</code> versions) are charged one credit.</p>

<p>Plus there is one important note in the documentation:</p>

<blockquote>
  <p>ℹ️ Note
Please note that when sending to a Topic, each message is evaluated against filter(s) before being made available on the Subscription. Each filter evaluation also counts against the credit limit (i.e. 1 credit per filter evaluation).</p>
</blockquote>

<p>That is, the evaluation of each filter is charged with one credit.</p>

<p>Well, here comes our math. For a given topic we had 56 subscribers and thus 56 filters. With an already relatively low load of 20 changes on entities per second, we would need <strong>1,160 credits. So <code class="highlighter-rouge">20 (send) + 20*56 (filter evaluation) + 20 (receive) = 1 160</code></strong> That is, 160 operations were throttled by ☹️.</p>

<h2 id="possible-solutions">Possible solutions?</h2>

<h3 id="go-to-premium-tier">Go to Premium tier</h3>

<p>Premium tier is on dedicated resources and throttling is not applied here. Unfortunately there is a big difference in price. With the current Standard tier we pay roughly 11€/month, with the Premium tier it would be over 700€/month.</p>

<p>I’m not saying we won’t upgrade to Premium tier, but the current price increase is too high relative to what we need from it.</p>

<h3 id="separate-topic-for-each-entity">Separate topic for each entity</h3>

<p>When sending, we will have a separate topic for each entity. The resulting credit consumption would be 40 credits <code class="highlighter-rouge">20 (sending) + 20 (receiving) = 40</code> .</p>

<p>Disadvantage, publisher has to decide which topic to send the message to.</p>

<h3 id="one-topic-one-subscription">One topic one subscription</h3>

<p>It will be sent to one topic. There will be one subscriber, who will have to decide in the body of the method what to do with the message.</p>

<p>The resulting credit consumption would be 40 credits <code class="highlighter-rouge">20 (send) + 20 (receive) = 40</code> .</p>

<p>Disadvantage, the subscriber has to decide what to do with the message.</p>

<h2 id="what-did-we-choose">What did we choose?</h2>

<p>We decided to go the way of one subscriber. In our context, this is a better solution than having a topic per entity.</p>

    </div>

    <div class="carousel">
        
    </div>

    <a class="u-url" href="/2024/03/24/azure-service-bus-how-we-did-not-use-topic-filters" hidden></a>

</article>

            <script data-name="BMC-Widget" data-cfasync="false" 
                src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" 
                data-id="minomartiniak" 
                data-description="Support me on Buy me a coffee!" 
                data-message="" 
                data-color="#00BF63" data-position="Right" 
                data-x_margin="25" 
                data-y_margin="50">
            </script>
        </div>
    </main><footer class="footer">
  <span>
    &copy; <time datetime="2024-08-02 20:13:27 +0000">2024</time> Milan Martiniak
    <a rel="me" href="https://github.com/burgyn"
      title="GitHub - burgyn">
      <span class="fa fa-github" aria-label="GitHub"></span>
    </a>
    <a rel="me" href="https://twitter.com/minomartiniak"
      title="Twitter - minomartiniak">
      <span class="fa fa-twitter" aria-label="Twitter"></span>
    </a>
    <a rel="me" href="https://linkedin.com/in/milanmartiniak" title="LinkedIn - Milan Martiniak">
      <span class="fa fa-linkedin" aria-label="LinkedIn"></span>
    </a>

    <a rel="me" href="https://blog.burgyn.online/feed.xml" title="RSS feed">
      <span class="fa fa-rss" aria-label="RSS"></span>
    </a>
  </span>
</footer><script type="text/javascript">
        $(document).ready(function () {
            $('.carousel').slick({
                dots: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                centerMode: false,
                focusOnSelect: true,
                infinite: false,
                adaptiveHeight: true
            });
        });

        lightbox.option({
            'resizeDuration': 50,
            'wrapAround': false,
            'fadeDuration': 50,
            'imageFadeDuration': 50,
            'resizeDuration': 50            
        })

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>

</html>