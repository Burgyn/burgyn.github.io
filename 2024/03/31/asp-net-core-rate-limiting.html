<!DOCTYPE html>
<html lang="en" class="colors theme-dark-2 entities fonts code-style"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">

    <!-- cache -->
    <meta http-equiv="Cache-Control" content="max-age=86400, must-revalidate" />    

    <!-- Pridanie Slick Carousel CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <!-- Pridanie Slick Carousel Theme CSS (voliteƒæn√©) -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <!-- Pridanie jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Pridanie Lightbox CSS a JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js"></script>
    <!-- Pridanie Slick Carousel JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

    <!-- IMPORTANT -->
    <script src="https://use.fontawesome.com/ee196462b9.js"></script>

    <!-- keywoards -->
    
    <meta name="keywords" content="Rate Limiting, API, ASP.NET Core, .NET 7, Resilience Patterns, Performance, AspNetCoreRateLimit, csharp, Fixed Window, Sliding Window, Token Bucket, Concurrency, Multi-tenancy">
    

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FYN9BGS01R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FYN9BGS01R');
    </script>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ASP.NET Core - Rate limiting | Burgyn‚Äôs blog</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="ASP.NET Core - Rate limiting" />
<meta name="author" content="Milan Martiniak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn how to implement rate limiting in ASP.NET Core using built-in features or custom algorithms. Covers multi-tenant scenarios." />
<meta property="og:description" content="Learn how to implement rate limiting in ASP.NET Core using built-in features or custom algorithms. Covers multi-tenant scenarios." />
<link rel="canonical" href="https://blog.burgyn.online/2024/03/31/asp-net-core-rate-limiting" />
<meta property="og:url" content="https://blog.burgyn.online/2024/03/31/asp-net-core-rate-limiting" />
<meta property="og:site_name" content="Burgyn‚Äôs blog" />
<meta property="og:image" content="https://blog.burgyn.online/assets/images/code_images/2024-03-31-asp-net-core-rate-limiting/cover.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-03-31T17:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://blog.burgyn.online/assets/images/code_images/2024-03-31-asp-net-core-rate-limiting/cover.png" />
<meta property="twitter:title" content="ASP.NET Core - Rate limiting" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Milan Martiniak","url":"https://burgyn.bio.link/"},"dateModified":"2024-03-31T17:00:00+00:00","datePublished":"2024-03-31T17:00:00+00:00","description":"Learn how to implement rate limiting in ASP.NET Core using built-in features or custom algorithms. Covers multi-tenant scenarios.","headline":"ASP.NET Core - Rate limiting","image":"https://blog.burgyn.online/assets/images/code_images/2024-03-31-asp-net-core-rate-limiting/cover.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.burgyn.online/2024/03/31/asp-net-core-rate-limiting"},"url":"https://blog.burgyn.online/2024/03/31/asp-net-core-rate-limiting"}</script>
<!-- End Jekyll SEO tag -->


    


    <!-- CSS -->
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-192x192" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-512x512" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">

    <!-- PWA -->
    <link rel="manifest" href="/assets/manifest.json">

    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="https://blog.burgyn.online/feed.xml" title="Burgyn's blog" />

    <!-- Google Analytics-->
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'dark'
        });
    </script>
</head><body>
    <svg width="0" height="0">
        <defs>
            <marker id="custom-arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
            <path d="M0,0 L0,7 L10,3.5 z"></path>
            </marker>
        </defs>
    </svg>
    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <div class="site-name">
        <img src="/assets/android-chrome-192x192.png" alt="Burgyn's logo" class="nav-logo">
        <h2 class="nav-title">Burgyn's blog</h2>
      </div>
    </a>    
    <ul>
      <li><a href="/">Posts</a></li>
      <li><a href="/about/">About me</a></li>
    </ul>
  </div>
</nav>

    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline"><p>ASP.NET Core - Rate limiting</p>
</h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2024-03-31T17:00:00+00:00" itemprop="datePublished">Mar 31, 2024
            </time><span itemprop="author" itemscope
                itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name"> | Milan Martiniak</span></span>
            | <span class="fa fa-tags" aria-label="Tags"> </span> 
            <span>
                <!-- <a href="/tags/asp.net core">asp.net core</a> -->
                asp.net core, 
            </span> 
            <span>
                <!-- <a href="/tags/csharp">csharp</a> -->
                csharp, 
            </span> 
            <span>
                <!-- <a href="/tags/architecture">architecture</a> -->
                architecture, 
            </span> 
            <span>
                <!-- <a href="/tags/multi-tenant">multi-tenant</a> -->
                multi-tenant
            </span>  
        </p>
    </header>

    
    <div class="post-thumbnail">
        <img src="/assets/images/code_images/2024-03-31-asp-net-core-rate-limiting/cover.png" alt="ASP.NET Core - Rate limiting" itemprop="image">
    </div>
    

    <div class="post-content e-content" itemprop="articleBody">
        <p>Rate limiting is a technique used mainly with APIs to control and limit the number of requests that clients can make to the API in a defined time. 
It belongs to the Resiliences family of paterns, which ensure that an API remains stable and available to all users, preventing misuse or overuse that could compromise its performance.</p>

<p>In the past, ASP.NET Core used the <a href="https://github.com/stefanprodan/AspNetCoreRateLimit">AspNetCoreRateLimit</a> library for rate limiting. As of .NET 7, ASP.NET Core rate limiting is available directly within the framework.</p>

<p>Choose one of the available rate limiting algorithms:</p>

<ul>
  <li>Fixed window</li>
  <li>Sliding window</li>
  <li>Token bucket</li>
  <li>Concurrency</li>
</ul>

<blockquote>
  <p>üíÅ You can find the individual methods explained in detail directly in <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/rate-limit?view=aspnetcore-8.0">documentation</a>.</p>
</blockquote>

<p>Register a policy first:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddRateLimiter</span><span class="p">(</span><span class="n">limiter</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="c1">// üëá Define the status code to be returned when the request is rejected.</span>
    <span class="n">limiter</span><span class="p">.</span><span class="n">RejectionStatusCode</span> <span class="p">=</span> <span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status429TooManyRequests</span><span class="p">;</span>

    <span class="c1">// üëá Define the policy.</span>
    <span class="n">limiter</span><span class="p">.</span><span class="nf">AddFixedWindowLimiter</span><span class="p">(</span><span class="n">policyName</span><span class="p">:</span> <span class="s">"products"</span><span class="p">,</span> <span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">options</span><span class="p">.</span><span class="n">PermitLimit</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
        <span class="n">options</span><span class="p">.</span><span class="n">Window</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>

        <span class="c1">// üëá If you want to use a queue to process requests that exceed the limit, you can set the following options.</span>
        <span class="n">options</span><span class="p">.</span><span class="n">QueueProcessingOrder</span> <span class="p">=</span> <span class="n">QueueProcessingOrder</span><span class="p">.</span><span class="n">OldestFirst</span><span class="p">;</span>
        <span class="n">options</span><span class="p">.</span><span class="n">QueueLimit</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Then add the middleware to the pipeline:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="p">.</span><span class="nf">UseRateLimiter</span><span class="p">();</span>
</code></pre></div></div>

<p>And use the policy when defining the endpoint:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/products"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"product1"</span><span class="p">,</span> <span class="s">"product2"</span><span class="p">,</span> <span class="s">"product3"</span><span class="p">,</span> <span class="s">"product4"</span> <span class="p">};</span>
<span class="p">}).</span><span class="nf">RequireRateLimiting</span><span class="p">(</span><span class="s">"products"</span><span class="p">);</span> <span class="c1">// üëà Add the policy to endpoint.</span>
</code></pre></div></div>

<p>If we have defined a policy on a whole group of endpoints, you can then disable rate limiting for a specific endpoint:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="k">group</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="nf">MapGroup</span><span class="p">(</span><span class="s">"/api/products"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">RequireRateLimiting</span><span class="p">(</span><span class="s">"products"</span><span class="p">);</span>

<span class="k">group</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"product1"</span><span class="p">,</span> <span class="s">"product2"</span><span class="p">,</span> <span class="s">"product3"</span><span class="p">,</span> <span class="s">"product4"</span> <span class="p">};</span>
<span class="p">}).</span><span class="nf">DisableRateLimiting</span><span class="p">();</span> <span class="c1">// üëà Disable the policy for the endpoint.</span>
</code></pre></div></div>

<p>For controllers, you can use the <code class="highlighter-rouge">[EnableRateLimiting(...)]</code> and <code class="highlighter-rouge">[DisableRateLimiting]</code> attributes.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">EnableRateLimiting</span><span class="p">(</span><span class="s">"products"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ProductsController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"product1"</span><span class="p">,</span> <span class="s">"product2"</span><span class="p">,</span> <span class="s">"product3"</span><span class="p">,</span> <span class="s">"product4"</span> <span class="p">};</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">DisableRateLimiting</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="s">"{id}"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">"product"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="multitenancy">Multitenancy</h2>

<p>If you are building a multi-tenant system, you probably want to have rate limiting for each tenant. For example, you want a tenant to be able to make 10 requests per second. Alternatively, you want to have different limits for different tenants. This can be achieved using the <code class="highlighter-rouge">RateLimitPartition</code> class.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddRateLimiter</span><span class="p">(</span><span class="n">limiter</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="c1">// üëá Define custom policy.</span>
    <span class="n">limiter</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"fixed-by-tenant"</span><span class="p">,</span>
        <span class="n">context</span> <span class="p">=&gt;</span> <span class="n">RateLimitPartition</span>
            <span class="p">.</span><span class="nf">GetFixedWindowLimiter</span><span class="p">(</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">"tenant-id"</span><span class="p">].</span><span class="nf">First</span><span class="p">(),</span> <span class="c1">// üëà Get tenant id</span>
                <span class="n">_</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">FixedWindowRateLimiterOptions</span>
                <span class="p">{</span>
                    <span class="n">Window</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
                    <span class="n">PermitLimit</span> <span class="p">=</span> <span class="m">10</span>
                <span class="p">}));</span>
    
    <span class="c1">// üëá If you want different policy per tenant</span>
    <span class="n">limiter</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"fixed-by-tenant-2"</span><span class="p">,</span>
        <span class="n">context</span> <span class="p">=&gt;</span> <span class="n">RateLimitPartition</span>
            <span class="p">.</span><span class="nf">GetFixedWindowLimiter</span><span class="p">(</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">"tenant-id"</span><span class="p">].</span><span class="nf">First</span><span class="p">(),</span> <span class="c1">// üëà Get tenant id</span>
                <span class="n">tenantId</span> <span class="p">=&gt;</span> <span class="nf">GetOptionsByTenant</span><span class="p">(</span><span class="n">tenantId</span><span class="p">)));</span> 
                <span class="c1">// üëÜ Get options by tenan from your configuration</span>
<span class="p">});</span>
</code></pre></div></div>

    </div>

    <div class="carousel">
        
    </div>

    <a class="u-url" href="/2024/03/31/asp-net-core-rate-limiting" hidden></a>

</article>

            <script data-name="BMC-Widget" data-cfasync="false" 
                src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" 
                data-id="minomartiniak" 
                data-description="Support me on Buy me a coffee!" 
                data-message="" 
                data-color="#00BF63" data-position="Right" 
                data-x_margin="25" 
                data-y_margin="50">
            </script>
        </div>
    </main><footer class="footer">
  <span>
    &copy; <time datetime="2024-12-17 08:23:53 +0000">2024</time> Milan Martiniak
    <a rel="me" href="https://github.com/burgyn"
      title="GitHub - burgyn">
      <span class="fa fa-github" aria-label="GitHub"></span>
    </a>
    <a rel="me" href="https://twitter.com/minomartiniak"
      title="Twitter - minomartiniak">
      <span class="fa fa-twitter" aria-label="Twitter"></span>
    </a>
    <a rel="me" href="https://linkedin.com/in/milanmartiniak" title="LinkedIn - Milan Martiniak">
      <span class="fa fa-linkedin" aria-label="LinkedIn"></span>
    </a>

    <a rel="me" href="https://blog.burgyn.online/feed.xml" title="RSS feed">
      <span class="fa fa-rss" aria-label="RSS"></span>
    </a>
  </span>
</footer><script type="text/javascript">
        $(document).ready(function () {
            $('.carousel').slick({
                dots: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                centerMode: false,
                focusOnSelect: true,
                infinite: false,
                adaptiveHeight: true
            });
        });

        lightbox.option({
            'resizeDuration': 50,
            'wrapAround': false,
            'fadeDuration': 50,
            'imageFadeDuration': 50,
            'resizeDuration': 50            
        })

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>

</html>