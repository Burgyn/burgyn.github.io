<!DOCTYPE html>
<html lang="en" class="colors theme-dark-2 entities fonts code-style"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">

    <!-- cache -->
    <meta http-equiv="Cache-Control" content="max-age=86400, must-revalidate" />    

    <!-- Pridanie Slick Carousel CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <!-- Pridanie Slick Carousel Theme CSS (voliteƒæn√©) -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <!-- Pridanie jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Pridanie Lightbox CSS a JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js"></script>
    <!-- Pridanie Slick Carousel JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

    <!-- IMPORTANT -->
    <script src="https://use.fontawesome.com/ee196462b9.js"></script>

    <!-- keywoards -->
    

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FYN9BGS01R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FYN9BGS01R');
    </script>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Azure Multi-Stage Pipelines (ƒças≈• 1. a 2. - Build a Nasadenie) | Burgyn‚Äôs blog</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Azure Multi-Stage Pipelines (ƒças≈• 1. a 2. - Build a Nasadenie)" />
<meta name="author" content="Milan Martiniak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Azure DevOps umo≈æ≈àuje dva sp√¥soby, ako vytvori≈• Continuous Deployment. M√¥≈æme pou≈æi≈• classic UI editor, alebo nov√Ω sp√¥sob pomocou YAML s√∫boru, kde jednotliv√© kroky, job-y, stage verziujeme ako k√≥d priamo v source control-e. Tento druh√Ω sp√¥sob sa naz√Ωva Multi-Stage Pipelines. Pomocou Multi-Stage Pipelines dok√°≈æete vytvori≈• proces nasadzovania od build-u, spustenia testov, nasadenia do r√¥znych prostred√≠ (napr√≠klad, Development, Staging, Production, ‚Ä¶) rozdelen√≠m na takzvan√© stages. Pr√°ve tento sp√¥sob si uk√°≈æeme v tomto poste." />
<meta property="og:description" content="Azure DevOps umo≈æ≈àuje dva sp√¥soby, ako vytvori≈• Continuous Deployment. M√¥≈æme pou≈æi≈• classic UI editor, alebo nov√Ω sp√¥sob pomocou YAML s√∫boru, kde jednotliv√© kroky, job-y, stage verziujeme ako k√≥d priamo v source control-e. Tento druh√Ω sp√¥sob sa naz√Ωva Multi-Stage Pipelines. Pomocou Multi-Stage Pipelines dok√°≈æete vytvori≈• proces nasadzovania od build-u, spustenia testov, nasadenia do r√¥znych prostred√≠ (napr√≠klad, Development, Staging, Production, ‚Ä¶) rozdelen√≠m na takzvan√© stages. Pr√°ve tento sp√¥sob si uk√°≈æeme v tomto poste." />
<link rel="canonical" href="https://blog.burgyn.online/2020/02/23/azure-multi-stage-pipelines" />
<meta property="og:url" content="https://blog.burgyn.online/2020/02/23/azure-multi-stage-pipelines" />
<meta property="og:site_name" content="Burgyn‚Äôs blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-02-23T16:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Azure Multi-Stage Pipelines (ƒças≈• 1. a 2. - Build a Nasadenie)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Milan Martiniak","url":"https://burgyn.bio.link/"},"dateModified":"2020-02-23T16:00:00+00:00","datePublished":"2020-02-23T16:00:00+00:00","description":"Azure DevOps umo≈æ≈àuje dva sp√¥soby, ako vytvori≈• Continuous Deployment. M√¥≈æme pou≈æi≈• classic UI editor, alebo nov√Ω sp√¥sob pomocou YAML s√∫boru, kde jednotliv√© kroky, job-y, stage verziujeme ako k√≥d priamo v source control-e. Tento druh√Ω sp√¥sob sa naz√Ωva Multi-Stage Pipelines. Pomocou Multi-Stage Pipelines dok√°≈æete vytvori≈• proces nasadzovania od build-u, spustenia testov, nasadenia do r√¥znych prostred√≠ (napr√≠klad, Development, Staging, Production, ‚Ä¶) rozdelen√≠m na takzvan√© stages. Pr√°ve tento sp√¥sob si uk√°≈æeme v tomto poste.","headline":"Azure Multi-Stage Pipelines (ƒças≈• 1. a 2. - Build a Nasadenie)","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.burgyn.online/2020/02/23/azure-multi-stage-pipelines"},"url":"https://blog.burgyn.online/2020/02/23/azure-multi-stage-pipelines"}</script>
<!-- End Jekyll SEO tag -->


    


    <!-- CSS -->
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-192x192" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-512x512" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">

    <!-- PWA -->
    <link rel="manifest" href="/assets/manifest.json">

    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="https://blog.burgyn.online/feed.xml" title="Burgyn's blog" />

    <!-- Google Analytics-->
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'dark'
        });
    </script>
</head><body>
    <svg width="0" height="0">
        <defs>
            <marker id="custom-arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
            <path d="M0,0 L0,7 L10,3.5 z"></path>
            </marker>
        </defs>
    </svg>
    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <div class="site-name">
        <img src="/assets/android-chrome-192x192.png" alt="Burgyn's logo" class="nav-logo">
        <h2 class="nav-title">Burgyn's blog</h2>
      </div>
    </a>    
    <ul>
      <li><a href="/">Posts</a></li>
      <li><a href="/about/">About me</a></li>
    </ul>
  </div>
</nav>

    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline"><p>Azure Multi-Stage Pipelines (ƒças≈• 1. a 2. - Build a Nasadenie)</p>
</h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2020-02-23T16:00:00+00:00" itemprop="datePublished">Feb 23, 2020
            </time><span itemprop="author" itemscope
                itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name"> | Milan Martiniak</span></span>
            | <span class="fa fa-tags" aria-label="Tags"> </span> 
            <span>
                <!-- <a href="/tags/Azure">Azure</a> -->
                Azure, 
            </span> 
            <span>
                <!-- <a href="/tags/DevOps">DevOps</a> -->
                DevOps, 
            </span> 
            <span>
                <!-- <a href="/tags/CI/CD">CI/CD</a> -->
                CI/CD, 
            </span> 
            <span>
                <!-- <a href="/tags/YAML">YAML</a> -->
                YAML
            </span>  
        </p>
    </header>

    

    <div class="post-content e-content" itemprop="articleBody">
        <p>Azure DevOps umo≈æ≈àuje dva sp√¥soby, ako vytvori≈• Continuous Deployment. M√¥≈æme pou≈æi≈• <em>classic</em> UI editor, alebo nov√Ω sp√¥sob pomocou YAML s√∫boru, kde jednotliv√© kroky, job-y, stage verziujeme ako k√≥d priamo v source control-e. Tento druh√Ω sp√¥sob sa naz√Ωva <a href="https://devblogs.microsoft.com/devops/whats-new-with-azure-pipelines/">Multi-Stage Pipelines</a>. Pomocou Multi-Stage Pipelines dok√°≈æete vytvori≈• proces nasadzovania od build-u, spustenia testov, nasadenia do r√¥znych prostred√≠ <em>(napr√≠klad, Development, Staging, Production, ‚Ä¶)</em> rozdelen√≠m na takzvan√© stages. Pr√°ve tento sp√¥sob si uk√°≈æeme v tomto poste.</p>

<p><img src="/assets/images/multi-stage-pipelines/stages.png" alt="stages" /></p>

<h2 id="ƒço-potrebujeme">ƒåo potrebujeme</h2>

<ul>
  <li><a href="https://azure.microsoft.com/en-us/free/">Azure account</a></li>
  <li><a href="https://azure.microsoft.com/en-us/services/devops/">Azure DevOps account</a></li>
  <li>
    <p>Zapn√∫≈• Public preview feature</p>

    <p><em>Multi-Stage Pipelines s√∫ v ƒçase p√≠sania tohto ƒçl√°nku e≈°te public preview a v DevOps port√°li ich je potrebn√© zapn√∫≈•.</em></p>

    <p><img src="/assets/images/multi-stage-pipelines/preview-feature.png" alt="preview feature" /></p>
  </li>
</ul>

<h2 id="ƒço-budeme-nasadzova≈•">ƒåo budeme nasadzova≈•?</h2>

<p>Vysk√∫≈°ame nasadi≈• demo aplik√°ciu, ktor√° pozost√°va z mikroslu≈æieb postaven√Ωch na ASP.NET Core frameworku a Angular-ov√©ho klienta. Mikroslu≈æby nasad√≠me do <a href="https://azure.microsoft.com/en-us/services/app-service/web/">Azure Web Apps</a> a klienta do <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blob-static-website">static website v Azure Storage</a>.</p>

<p><img src="/assets/images/multi-stage-pipelines/architecture.png" alt="architecture" /></p>

<blockquote>
  <p>Demo si m√¥≈æete forkn√∫≈• na GitHub-e. <a href="https://github.com/Kros-sk/Kros.AspNetCore.BestPractices">Mikroslu≈æby</a>, <a href="https://github.com/Kros-sk/Kros.Angular.BestPractices">Angluar klient</a>.</p>
</blockquote>

<h2 id="ƒças≈•-1---build">ƒåas≈• 1. - Build</h2>

<p><em>(Ak yaml build pipeline-u ovl√°date, m√¥≈æete preskoƒçi≈• rovno na ƒças≈• nasadzovania <a href="#&#x10D;as&#x165;-2---nasadzovanie">ƒåas≈• 2. - Nasadzovanie</a>.)</em></p>

<p>V prvom kroku mus√≠me na≈°e projekty zbuildova≈•. Do projektu <code class="highlighter-rouge">Kros.AspNetCore.BestPractices</code> si prid√°me yaml s√∫bor s defin√≠ciou buildu. Pomenujeme ho napr√≠klad <code class="highlighter-rouge">build-demo-ci.yml</code> <em>(ci - continuous integrations. Bude sa sp√∫≈°≈•a≈• po ka≈ædom commit-e do master vetvy)</em>.</p>

<blockquote>
  <p>üí° Odpor√∫ƒçam umiest≈àova≈• yaml s√∫bory do zvl√°≈°≈• adres√°ra. Napr√≠klad <code class="highlighter-rouge">pipelines</code>.</p>
</blockquote>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">trigger</span><span class="pi">:</span>
  <span class="na">batch</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">branches</span><span class="pi">:</span>
    <span class="na">include</span><span class="pi">:</span> <span class="pi">[</span> <span class="s1">'</span><span class="s">master'</span> <span class="pi">]</span>

<span class="na">pool</span><span class="pi">:</span>
  <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

<span class="na">workspace</span><span class="pi">:</span>
  <span class="na">clean</span><span class="pi">:</span> <span class="s">outputs</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">build-steps-core.yml</span>
  <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">build-steps-publish.yml</span>
</code></pre></div></div>

<p>ƒåas≈• <code class="highlighter-rouge">trigger</code> definuje udalosti, ktor√© sp√∫≈°≈•aj√∫ dan√Ω build. V na≈°om pr√≠pade m√°me podmienku na <code class="highlighter-rouge">master</code> vetvu a chceme aby sa nov√Ω build nespustil pokiaƒæ neskonƒçil predch√°dzaj√∫ci <code class="highlighter-rouge">batch: true</code>. <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/triggers?view=azure-devops&amp;tabs=yaml">Viac info o triggroch</a>.</p>

<p>Na buildovanie v√°≈°ho k√≥du, alebo jeho nasadzovanie potrebujete jedn√©ho alebo viacer√Ωch agentov. V r√°mci DevOps konta m√°te automaticky jedn√©ho free <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=browser#microsoft-hosted-agents">Microsoft-hosted agenta</a></p>

<blockquote>
  <p>‚ö† Free agent m√° obmedzen√Ω poƒçet hod√≠n behu za mesiac. Na mal√Ω projekt to staƒç√≠. Ale pokiaƒæ sp√∫≈°≈•ate buildy / nasadzovanie niekoƒækokr√°t denne, tak v√°m tento ƒças pravdepodobne d√¥jde.</p>
</blockquote>

<p>V na≈°om pr√≠pade pou≈æijeme na buildovanie agenta z pripraven√©ho Ubuntu obrazu <code class="highlighter-rouge">vmImage: ubuntu-latest</code>. Agentov je mo≈æn√© hostova≈• aj na svoj√≠ch on-premise ma≈°in√°ch. <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=browser#install">Self-hosted agents</a>.</p>

<blockquote>
  <p>üí° Pokiaƒæ m√°te Visual Studio Enterprise licenciu, tak na ka≈æd√∫ tak√∫to licenciu m√°te jedn√©ho <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/billing/buy-more-build-vs?view=azure-devops#self-hosted-private-projects">Self-hosted agenta zadarmo</a>.</p>
</blockquote>

<p>Cel√Ω proces build-ovacej pipeliny pozost√°va z niekoƒæk√Ωch krokov. Napr√≠klad: build, spustenie testov, exportovanie v√Ωsledkov testov pre bud√∫ce zobrazenie, publish projektu a publish <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/artifacts/artifacts-overview?view=azure-devops">artefaktov</a> pre nasadenie. Tieto kroky sa definuj√∫ v ƒçasti <code class="highlighter-rouge">steps</code> pomocou task-ov. K dispoz√≠ci√≠ je veƒæk√© mno≈æstvo preddefinovan√Ωch <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/?view=azure-devops">task-ov</a>, task-ov z <a href="https://marketplace.visualstudio.com/search?target=AzureDevOps&amp;category=Azure%20Pipelines&amp;sortBy=Installs">marketplace-u</a>, alebo si m√¥≈æte vytvori≈• <a href="https://www.parksq.co.uk/azure-dev-ops/custom-build-tasks">vlastn√Ω task</a>.</p>

<p>Jednolitv√© kroky / skupiny krokov m√¥≈æme extrahova≈• do samostatn√Ωch s√∫borov a tieto s√∫bory vyu≈æ√≠va≈• v r√¥znych pipeline-ach <code class="highlighter-rouge">- template: build-steps-core.yml</code> <em>(je to jednoduch≈°ie ako vytv√°ra≈• custom task)</em>. Najjednoduch≈°ie je, keƒè m√°te t√∫to ≈°abl√≥nu v rovnakom repe ako v na≈°om pr√≠pade. Ale je mo≈æn√© v≈°eobecn√© ≈°abl√≥ny umiest≈àova≈• do samostatn√©ho repa.</p>

<p>Napr√≠klad:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">resources</span><span class="pi">:</span>
  <span class="na">repositories</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">repository</span><span class="pi">:</span> <span class="s">templates</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">DevShared/Templates</span>
</code></pre></div></div>

<p>Kroky pre samotn√Ω build m√°me definovan√© v s√∫bore <code class="highlighter-rouge">pipelines/build-steps-core.yml</code>.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">buildConfiguration</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Release'</span>
  <span class="na">buildVerbosity</span><span class="pi">:</span> <span class="s1">'</span><span class="s">minimal'</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">DotNetCoreCLI@2</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">projects</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/*.csproj'</span>
      <span class="na">arguments</span><span class="pi">:</span> <span class="s1">'</span><span class="s">--configuration</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">parameters.buildConfiguration</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">--verbosity</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">parameters.buildVerbosity</span><span class="nv"> </span><span class="s">}}'</span>

  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">DotNetCoreCLI@2</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Test</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">test'</span>
      <span class="na">projects</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/*.csproj'</span>
      <span class="na">arguments</span><span class="pi">:</span> <span class="s1">'</span><span class="s">--configuration</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">parameters.buildConfiguration</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">--verbosity</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">parameters.buildVerbosity</span><span class="nv"> </span><span class="s">}}'</span>
</code></pre></div></div>

<p><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/dotnet-core-cli?view=azure-devops">DotNetCoreCLI@2</a> je task pre vyu≈æ√≠vanie <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/?tabs=netcore2x">dotnet core cli</a>. V tomto pr√≠pade ho vyu≈æ√≠vame na build a spustenie testov.</p>

<p>V ƒèal≈°om kroku si mus√≠me vypublikova≈• artefakty <code class="highlighter-rouge">build-steps-publish.yml</code></p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">buildConfiguration</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Release'</span>
  <span class="na">buildVerbosity</span><span class="pi">:</span> <span class="s1">'</span><span class="s">minimal'</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">DotNetCoreCLI@2</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Publish</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">command</span><span class="pi">:</span> <span class="s">publish</span>
      <span class="na">projects</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/*.csproj'</span>
      <span class="na">arguments</span><span class="pi">:</span> <span class="s1">'</span><span class="s">--configuration</span><span class="nv"> </span><span class="s">$</span><span class="nv"> </span><span class="s">--verbosity</span><span class="nv"> </span><span class="s">$</span><span class="nv"> </span><span class="s">--output</span><span class="nv"> </span><span class="s">"$(Build.ArtifactStagingDirectory)"'</span>
      <span class="na">publishWebProjects</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">modifyOutputPath</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">zipAfterPublish</span><span class="pi">:</span> <span class="no">true</span>

  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CopyFiles@2</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Copy</span><span class="nv"> </span><span class="s">tests</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">/tests/PostDeployTests</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Artifacts'</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">SourceFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.SourcesDirectory)/tests/Services/PostDeployTests'</span>
      <span class="na">Contents</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**'</span>
      <span class="na">TargetFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)/PostDeployTests'</span>
      <span class="na">OverWrite</span><span class="pi">:</span> <span class="no">true</span>

  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">CopyFiles@2</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Copy</span><span class="nv"> </span><span class="s">templates</span><span class="nv"> </span><span class="s">definition</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">/pipelines</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">artifact</span><span class="nv"> </span><span class="s">pipelines'</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">SourceFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.SourcesDirectory)/pipelines'</span>
      <span class="na">Contents</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**'</span>
      <span class="na">TargetFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)/pipelines'</span>
      <span class="na">OverWrite</span><span class="pi">:</span> <span class="no">true</span>

  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">PublishBuildArtifacts@1</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Publish</span><span class="nv"> </span><span class="s">Artifacts'</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">PathtoPublish</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)'</span>
</code></pre></div></div>

<p>Sk√¥r ako vypublikujeme artefakty do adres√°ra definovan√©ho <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&amp;tabs=yaml">premennou</a> <code class="highlighter-rouge">$(Build.ArtifactStagingDirectory)</code>, tak si e≈°te k artetaktom, pomocou task-u <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/copy-files?view=azure-devops&amp;tabs=yaml">CopyFiles@2</a>, nakop√≠rujeme ƒèal≈°ie s√∫bory, ktor√© neboli s√∫ƒças≈•ou buildu, ale chceme ich pre ƒèal≈°ie pou≈æitie v release pipelnie. V na≈°om pr√≠pade tam budeme kop√≠rova≈• s√∫bory z adres√°ra <code class="highlighter-rouge">/tests/Services/PostDeployTests</code> a <code class="highlighter-rouge">pipelines</code>.</p>

<p>Potvrd√≠me zmeny, push-neme ich na server <code class="highlighter-rouge">git add . | git commit -m "Creating build pipeline" | git push</code> a presunieme sa do <a href="https://dev.azure.com">DevOps port√°lu</a>.</p>

<p>V DevOps mus√≠me ma≈• zalo≈æen√Ω projekt. V projekte sa presunieme do sekcie Pipelines a ideme prida≈• nov√∫ pipeline-u definovan√∫ v GitHub repe.</p>

<p><img src="/assets/images/multi-stage-pipelines/newPipeline.png" alt="new pipeline" /></p>

<p>Voƒçi GitHub-u je potrebn√© sa autorizova≈• , aby ste mohli prida≈• build pre va≈°e repo.</p>

<p><img src="/assets/images/multi-stage-pipelines/authorizeGitHub.png" alt="github authorization" /></p>

<p>Po vybran√≠ repa, v ktorom sa nach√°dza va≈°a nov√° pipeline-a mus√≠me e≈°te zvoli≈•, ≈æe ideme pou≈æi≈• existuj√∫ci YAML s√∫bor a nie vytv√°ra≈• nov√Ω.</p>

<p><img src="/assets/images/multi-stage-pipelines/existingYamlFile.png" alt="existing ymal file" /></p>

<p>Ost√°va u≈æ len ulo≈æi≈• a spusti≈•. Je mo≈æn√©, ≈æe pri prvom spusten√≠ budete musie≈• povoli≈• pr√≠stup k resourcom.</p>

<p><img src="/assets/images/multi-stage-pipelines/permit.png" alt="permit" /></p>

<p>Ak sme v≈°etko spravili spr√°vne, tak by n√°≈° prv√Ω build mal √∫spe≈°ne zbehn√∫≈•.</p>

<p><img src="/assets/images/multi-stage-pipelines/successRun.png" alt="success run" /></p>

<blockquote>
  <p>üí° Tak√Ωto build vieme vy≈æadova≈• aj pri PR. To znamen√°, ≈æe pokiaƒæ n√°m neprejde build, alebo zlyh√° nejak√Ω test, tak automaticky nedovol√≠me schv√°lenie PR. Odpor√∫ƒçam pre build, ktor√Ω sa bude sp√∫≈°≈•a≈• v r√°mci PR vytvori≈• samostatn√∫ pipeline-u, kde nebudeme publikova≈• artefakty. Tie nie s√∫ v tomto pr√≠pade potrebn√© a zr√Ωchlime tak odozvu na n√°≈° PR.</p>
</blockquote>

<p>Build Angular projektu vytvor√≠me veƒæmi podobne, preto to tu nebudem rozpisova≈•. Pr√≠klad ako to m√¥≈æe vyzera≈• n√°jdete priamo v <a href="https://github.com/Kros-sk/Kros.Angular.BestPractices/blob/master/pipelines/build-angular-ci.yml">damom projekte</a>.</p>

<p>E≈°te typ na z√°ver tejto ƒçasti. Azure DevOps nazval va≈°u pipeline-u podƒæa v√°≈°ho projektu. Ak ju chcete premenova≈• urob√≠te to tak, ≈æe vyberiete dan√∫ pipeline-u a z menu zvol√≠te Rename / Move. <em>(u≈æ p√°rkr√°t som to nevedel n√°js≈• üòî)</em></p>

<p><img src="/assets/images/multi-stage-pipelines/rename.png" alt="rename" /></p>

<p>M√¥≈æme si ho pomenova≈• napr√≠klad <code class="highlighter-rouge">Build - Demo - CI</code>. Na tento n√°zov sa budeme odkazova≈• v release pipeline.</p>

<h2 id="ƒças≈•-2---nasadzovanie">ƒåas≈• 2. - Nasadzovanie</h2>

<p>Artefakty m√°me pripraven√©. M√¥≈æme zaƒça≈• nasadzova≈•. V tomto pr√≠klade budeme nasadzova≈• do dvoch prostred√≠. Testing a Production. Po nasaden√≠ do testovacieho prostredia spust√≠me UI a Postman testy a pokiaƒæ tieto testy prejd√∫ a schv√°lime nasadenie do produkcie, tak swap-neme jednotliv√© slu≈æby do produkƒçn√©ho prostredia.</p>

<p>Pipeline-a, ktor√∫ ideme vytv√°ra≈• bude vyzera≈• nasledovne:
<img src="/assets/images/multi-stage-pipelines/pipeline.png" alt="pipeline" /></p>

<blockquote>
  <p>Je mo≈æn√© vytvori≈• akokoƒævek komplexn√© a sofistikovan√© pipeline-y. V≈°etko z√°le≈æ√≠ od va≈°ich procesov. T√°to je relat√≠vne jednoduch√°, ale pok√∫sim sa na nej uk√°za≈• v≈°etky podstatn√© veci.</p>
</blockquote>

<h3 id="vytvorenie-kostry-deployment-pipeline-y">Vytvorenie kostry deployment pipeline-y</h3>

<p>M√¥≈æme pokraƒçova≈• v p√¥vodnom yaml s√∫bore v ktorom sme definovali build. Z viacer√Ωch d√¥vodov je ale vhodn√© rozdeli≈• proces zostavenia produktu a jeho deployment. <em>(Napr√≠klad chcete jednu konkr√©tnu verziu build-u pou≈æi≈• vo viacer√Ωch deployment pipeline-n√°ch, alebo naopak chcete jednu deployment pipelinu pou≈æi≈• viackr√°t s r√¥znymi verziami build-u.)</em></p>

<p>Do projektu <code class="highlighter-rouge">Kros.AspNetCore.BestPractices</code> si prid√°me yaml s√∫bor s defin√≠ciou deployment procesu. Pomenujeme ho napr√≠klad <code class="highlighter-rouge">deploy-demo-cd.yml</code> <em>(cd - continuous deployment. Bude sa sp√∫≈°≈•a≈• po skonƒçen√≠ build-u <code class="highlighter-rouge">Build - Demo- CI</code>)</em>.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">trigger</span><span class="pi">:</span> <span class="s">none</span>

<span class="na">resources</span><span class="pi">:</span>
  <span class="na">pipelines</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">pipeline</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">Build - Demo - CI</span>
    <span class="na">trigger</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Tests'</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Services</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Testing</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
            <span class="na">artifact</span><span class="pi">:</span> <span class="s">drop</span>
            <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">artifacts'</span>

          <span class="pi">-</span> <span class="na">powershell</span><span class="pi">:</span> <span class="s">echo Deploy to testing</span>

<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Production'</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Production'</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Services</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Production</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
            <span class="na">artifact</span><span class="pi">:</span> <span class="s">drop</span>
            <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">artifacts'</span>

          <span class="pi">-</span> <span class="na">powershell</span><span class="pi">:</span> <span class="s">echo Deploy to production</span>
</code></pre></div></div>

<p>≈†tandardn√Ω trigger vypneme <code class="highlighter-rouge">trigger: none</code>, preto≈æe nechceme aby sa sp√∫≈°≈•ala po commit-e do vetvy, ale chceme ju sp√∫≈°≈•a≈• po √∫spe≈°nom skonƒçen√≠ build pipeline-y.</p>

<p>Pomocou sekcie <code class="highlighter-rouge">resources</code> vieme prida≈• odkaz na in√© pipeline-y.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">resources</span><span class="pi">:</span>
  <span class="na">pipelines</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">pipeline</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">build-demo-ci</span>
    <span class="na">trigger</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>V na≈°om pr√≠pade prid√°vame odkaz na <code class="highlighter-rouge">build-demo-ci</code>. Pomenujeme ju <code class="highlighter-rouge">ToDosDemoServices</code> <em>(na tento n√°zov sa budeme ƒèalej odkazova≈•)</em> a nastav√≠me ju ako trigger, ktor√Ω bude sp√∫≈°≈•a≈• na≈°u deployment pipeline-u <code class="highlighter-rouge">trigger: true</code>.</p>

<p>Pomocou <code class="highlighter-rouge">stages</code> rozdel√≠me na≈°u pipeline-u na dve ƒçasti <code class="highlighter-rouge">- stage: 'Tests'</code> a <code class="highlighter-rouge">- stage: 'Production'</code>. <code class="highlighter-rouge">displayName:</code> n√°m d√° ƒæudsk√Ω popis, ktor√Ω sa bude zobrazova≈• vo vizualiz√°ci√≠ procesu. ≈†tandardne jednotliv√© stages sa vykon√°vaj√∫ v porad√≠ ako s√∫ definovan√©. Ak toto chceme zmeni≈•, alebo chceme docieli≈• zlo≈æitej≈°√≠ proces ako napr√≠klad <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/stages?view=azure-devops&amp;tabs=yaml#specify-dependencies">fan-out fan-in</a>, tak m√¥≈æeme pou≈æi≈• nastavenie <code class="highlighter-rouge">dependsOn:</code>.</p>

<p>V ƒçasti venovanej buildu sme nespom√≠nali takzvan√© job-y. Preto≈æe v na≈°om pr√≠pade sa tam pou≈æ√≠val jeden implicitn√Ω job. Jednotliv√© kroky m√¥≈æme rozdeƒæova≈• do <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&amp;tabs=yaml">viacer√Ωch job-ov</a>. Pokiaƒæ m√°me v definovanom pool-e viacer√Ωch voƒæn√Ωch agentov, tak tieto job-y m√¥≈æu vykon√°va≈• definovan√© kroky na t√Ωchto agentoch paralelne. <em>(Ka≈æd√Ω agent v danom ƒçase m√¥≈æe vykon√°va≈• kroky z jedn√©ho job-u.)</em></p>

<p>Pre deployment proces sa odpor√∫ƒça pou≈æi≈• ≈°peci√°lny <code class="highlighter-rouge">- deployment:</code> typ job-u. Tento typ job-u umo≈æ≈àuje viacer√© strat√©gie deploymentu. Viac sa doƒç√≠tate v <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/deployment-jobs?view=azure-devops">dokument√°cii</a>.</p>

<p>Keƒè m√°me definovan√© stages, job-y a stat√©giu, m√¥≈æme sa pusti≈• do definovania jednotliv√Ωch krokov.
Ako prv√Ω krok potrebujeme stiahnu≈• artefakty z n√°≈°ho build-u. <em>(pokiaƒæ m√°me build a deployment v jednej yaml pipeline tak tento krok m√¥≈æeme vynecha≈•)</em></p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
  <span class="na">artifact</span><span class="pi">:</span> <span class="s">drop</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">artifacts'</span>
</code></pre></div></div>

<p>S≈•ahujeme artefakty pomenovan√© <code class="highlighter-rouge">drop</code> z pipeline-y <code class="highlighter-rouge">ToDosDemoServices</code>.</p>

<p>ƒéal≈°ie kroky budeme definova≈• o chv√≠ƒæu, zatiaƒæ si tam dajme len jednoduch√Ω v√Ωpis <code class="highlighter-rouge">- powershell: echo Deploy to production</code>.</p>

<p>Potvrd√≠me zmeny, push-neme ich na server <code class="highlighter-rouge">git add . | git commit -m "Creating deployment pipeline" | git push</code> a presunieme sa do <a href="https://dev.azure.com">DevOps port√°lu</a>, kde prid√°me pipeline-u rovnako ako pri build pipeline.</p>

<p>Pokiaƒæ ideme spusti≈• t√∫to pipeline-u ruƒçne, tak si m√¥≈æme zvoli≈• ktor√© stage chceme spusti≈•.</p>

<p><img src="/assets/images/multi-stage-pipelines/selectStages.png" alt="select stages" /></p>

<h3 id="azure-service-connection">Azure service connection</h3>

<p>Pokiaƒæ chceme pomocou Azure DevOps Pipelines nasadzova≈• do Azure slu≈æieb, mus√≠me si prida≈• spojenie na na≈°u Azure Subscription.</p>

<p><img src="/assets/images/multi-stage-pipelines/addAzureSubscription1.png" alt="add azure connection" /></p>

<p>V nastaveniach projektu zvol√≠me <strong>Service connection</strong>, kde prid√°me nov√© <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints?view=azure-devops&amp;tabs=yaml#sep-azure-resource-manager"><strong>Azure Resource Manager</strong></a> spojenie. Ide√°lne ak m√°te jedno konto pre Azure aj Azure DevOps, v tom pr√≠pade zvoƒæte (Automatic) v opaƒçnom pr√≠pade (manula).</p>

<p><img src="/assets/images/multi-stage-pipelines/addAzureSubscription2.png" alt="add azure connection" /></p>

<h3 id="nasadenie-jednej-slu≈æby">Nasadenie jednej slu≈æby</h3>

<p>Princ√≠p nasadzovania si uk√°≈æeme na jednej zo slu≈æieb. Napr√≠klad <code class="highlighter-rouge">ToDos</code>.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">variables</span><span class="pi">:</span>
  <span class="na">AzureSubscriptionName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Demo</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">Subscription'</span>
  <span class="na">ResourceGoupName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mino-demo-rsg'</span>
  <span class="na">SlotName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Tests'</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Services</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Testing</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
            <span class="na">artifact</span><span class="pi">:</span> <span class="s">drop</span>
            <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">artifacts'</span>

          <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureWebApp@1</span>
            <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Deploy:</span><span class="nv"> </span><span class="s">ToDos'</span>
            <span class="na">inputs</span><span class="pi">:</span>
              <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s">$(AzureSubscriptionName)</span>
              <span class="na">appName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mino-demo-todos-api'</span>
              <span class="na">package</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Pipeline.Workspace)/ToDosDemoServices/drop/Kros.ToDos.Api.zip'</span>
              <span class="na">deployToSlotOrASE</span><span class="pi">:</span> <span class="no">true</span>
              <span class="na">resourceGroupName</span><span class="pi">:</span> <span class="s">$(ResourceGoupName)</span>
              <span class="na">slotName</span><span class="pi">:</span> <span class="s">$(SlotName)</span>
</code></pre></div></div>

<p>Na nasadenie na≈°ej slu≈æby do Azure WebApps m√¥≈æeme pou≈æi≈• task <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-rm-web-app?view=azure-devops">AzureWebApp@1</a>. Ktor√©mu mus√≠me nastavi≈• <code class="highlighter-rouge">azureSubscription</code>. T√∫to hodnotu nastav√≠me na n√°zov n√°≈°ho spojenia s Azure. ƒéalej <code class="highlighter-rouge">appName</code> ƒço je n√°zov va≈°ej Azure WebApps slu≈æby kam chcete nasadi≈• aplik√°ciu, ktor√∫ dan√Ω task hƒæad√° na mieste, ktor√© definujete pomocou <code class="highlighter-rouge">package</code> parametra. Vyu≈æ√≠vame tu premenn√∫ <code class="highlighter-rouge">$(Pipeline.Workspace)</code> kde m√°me stiahnut√© na≈°e artefakty. Artefakty z pipeline-y <code class="highlighter-rouge">ToDosDemoServices</code> sa stiahli do pr√≠slu≈°n√©ho podadres√°ra. Tieto tri nastavenia staƒçia pri ≈°tandardnom nasadzovan√≠.</p>

<p>My v≈°ak chceme vyu≈æi≈• mo≈ænosti <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots">slotov v Azure WebApps</a>, ƒço n√°m umo≈æn√≠ pomocou swap-ovania dostiahnu≈• bezodst√°vkov√© nasadzovanie. Preto mus√≠me nastavi≈• parameter <code class="highlighter-rouge">deployToSlotOrASE: true</code>, n√°zov resource group-y v ktorej sa nach√°dza na≈°a slu≈æba <code class="highlighter-rouge">resourceGroupName: $(ResourceGoupName)</code> a n√°zov slotu do ktor√©ho nasadzujeme <code class="highlighter-rouge">slotName: $(SlotName)</code>.</p>

<p>Miesto toho aby sme tieto hodnoty zad√°vali priamo, definujeme si ich ako premenn√©. Bude sa n√°m to ƒæah≈°ie spravova≈• a m√¥≈æme ich pou≈æ√≠va≈• na viacer√Ωch miestach s t√Ωm, ≈æe definovan√© ich m√°me len na jednom mieste. Premenn√© <code class="highlighter-rouge">AzureSubscriptionName</code>, <code class="highlighter-rouge">ResourceGoupName</code> a <code class="highlighter-rouge">SlotName</code> si definujeme na √∫rovni celej pipeline-y. Premenn√© je e≈°te mo≈æn√© definova≈• na √∫rovni stage-u, extrahova≈• do ≈°abl√≥ny, alebo pou≈æi≈• <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/library/variable-groups?view=azure-devops&amp;tabs=yaml">priamo z DevOps</a>.</p>

<p>Pokiaƒæ sme sa nikde nepom√Ωlili, tak po potvrden√≠ zmien by sa n√°m prva slu≈æba mala √∫spe≈°ne nasadi≈•.</p>

<h3 id="refaktor-a-nasadenie-v≈°etk√Ωch-slu≈æieb">Refaktor a nasadenie v≈°etk√Ωch slu≈æieb</h3>

<p>Pre nasadzovanie ostatn√Ωch slu≈æieb m√¥≈æme prid√°va≈• rovnak√Ωm sp√¥sobom ƒèal≈°ie kroky. D√° sa to ale aj elegantnej≈°ie. Azure Pipelines podporuj√∫ viacer√© <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/expressions?view=azure-devops">expressions</a>. Jednou z nich je aj <a href="https://github.com/microsoft/azure-pipelines-yaml/blob/master/design/each-expression.md">‚ÄúEach‚Äù Template Expresion</a>, ktor√° sa d√° pou≈æi≈• podobne ako be≈æn√Ω <code class="highlighter-rouge">foreach</code> v ostat√Ωch jazykoch.
Samotn√© nasadenie slu≈æieb extrahujeme do ≈°abl√≥ny s n√°zvom <code class="highlighter-rouge">deploy-microservice.yml</code>.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">microservices</span><span class="pi">:</span> <span class="pi">[]</span>

<span class="na">steps</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">${{ each microservice in parameters.microservices }}</span><span class="err">:</span> <span class="c1"># Each microservice</span>
  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureWebApp@1</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Microservice</span><span class="nv"> </span><span class="s">Deploy:</span><span class="nv"> </span><span class="s">${{microservice}}'</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s">$(AzureSubscriptionName)</span>
      <span class="na">appName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mino-demo-${{microservice}}-api'</span>
      <span class="na">package</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Pipeline.Workspace)/ToDosDemoServices/drop/Kros.${{microservice}}.Api.zip'</span>
      <span class="na">deployToSlotOrASE</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">resourceGroupName</span><span class="pi">:</span> <span class="s">$(ResourceGoupName)</span>
      <span class="na">slotName</span><span class="pi">:</span> <span class="s">$(SlotName)</span>
</code></pre></div></div>

<p>Vstupn√Ωm parametrom pre t√∫to ≈°abl√≥nu je zoznam n√°zov jednotliv√Ωch mikroslu≈æieb <code class="highlighter-rouge">microservices: []</code>.</p>

<blockquote>
  <p>Pri takejto automatiz√°ci√≠ n√° vedia veƒæmi pom√¥c≈• konvencie n√°zvoslovia. Pokiaƒæ m√°me nejak√Ω vzor pre naz√Ωvanie slu≈æieb, artefaktov, ‚Ä¶, tak si m√¥≈æme tak√Ωmto sp√¥sobom zjednodu≈°i≈• ≈æivot.</p>
</blockquote>

<p>Pomocou kon≈°trukcie  <code class="highlighter-rouge">${{ each microservice in parameters.microservices }}</code>  rozkop√≠rujeme dan√© kroky <em>(v na≈°om pr√≠pade jeden)</em> pre ka≈æd√Ω n√°zov mikroslu≈æby. Na n√°zov konkr√©tnej slu≈æby sa referencujeme pomocou kon≈°trukcie  <code class="highlighter-rouge">${{microservice}}</code> .</p>

<p>≈†abl√≥nu pou≈æijeme v na≈°ej pipeline nasledovne:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">variables</span><span class="pi">:</span>
  <span class="na">AzureSubscriptionName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Demo</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">Subscription'</span>
  <span class="na">ResourceGoupName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mino-demo-rsg'</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Tests'</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">SlotName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Services</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Testing</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
            <span class="na">artifact</span><span class="pi">:</span> <span class="s">drop</span>
            <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">artifacts'</span>

          <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">deploy-microservice.yml</span>
            <span class="na">parameters</span><span class="pi">:</span>
              <span class="na">microservices</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">ToDos'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">Authorization'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">Organizations'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">ApiGateway'</span><span class="pi">]</span>
</code></pre></div></div>

<blockquote>
  <p>Premenn√© ako napr√≠klad <code class="highlighter-rouge">$(AzureSubscriptionName)</code> si v na≈°om pr√≠pade m√¥≈æme dovoli≈• necha≈• takto. Preprocessing, ktor√Ω spracov√°va t√∫to pipelinu rozbaƒæuje jednotliv√© ≈°abl√≥ny a inplace-suje ich priamo do pipeline-y. Pokiaƒæ v≈°ak t√∫to ≈°abl√≥ny chceme ma≈• v≈°eobecn√∫ a pou≈æiteƒæn√∫ aj v in√Ωch pipeline-ach / projektoch <em>(ƒço asi chceme)</em>, tak by sme z nich mali spravi≈• premenn√©. <em>(Popr√≠pade poriadne zdokumentova≈• ak√© premenn√© maj√∫ by≈• nastaven√© pre fungovanie danej ≈°abl√≥ny.)</em></p>
</blockquote>

<p>Tak√Ωmto sp√¥sobom sme nasadili v≈°etky potrebn√© slu≈æby. Backend m√°me nasaden√Ω do testovacieho prostredia. Teraz by malo nasledova≈• spustenie integraƒçn√Ωch testov. Niekedy v ƒèal≈°om ƒçl√°nku si uk√°≈æeme ako spusti≈• postman testy.</p>

<h3 id="nasadenie-angular-aplik√°cie">Nasadenie Angular aplik√°cie</h3>

<p>Teraz je naƒçase nasadi≈• klienta. Tak ako sme spom√≠nali na zaƒçiatku, tak Angular aplik√°ciu budeme nasadzova≈• do Azure Storage Static Websites. ƒåo v jednoduchosti znamen√° pomocou <a href="https://docs.microsoft.com/en-us/cli/azure/get-started-with-azure-cli?view=azure-cli-latest">Azure CLI</a> nakop√≠rova≈• s√∫bory na blob storage.</p>

<p>Nasadenie klienta m√°me definovan√© v ≈°abl√≥ne <code class="highlighter-rouge">deploy-client.yml</code>.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">storageAccount</span><span class="pi">:</span> <span class="s">string</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">ToDosDemoClient</span>
    <span class="na">artifact</span><span class="pi">:</span> <span class="s">app</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">client</span><span class="nv"> </span><span class="s">app</span><span class="nv"> </span><span class="s">artifacts'</span>

  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureCLI@1</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Delete</span><span class="nv"> </span><span class="s">files</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">storage'</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AzureSubscriptionName)'</span>
      <span class="na">scriptLocation</span><span class="pi">:</span> <span class="s">inlineScript</span>
      <span class="na">inlineScript</span><span class="pi">:</span> <span class="s1">'</span><span class="s">az</span><span class="nv"> </span><span class="s">storage</span><span class="nv"> </span><span class="s">blob</span><span class="nv"> </span><span class="s">delete-batch</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">$web</span><span class="nv"> </span><span class="s">--account-name</span><span class="nv"> </span><span class="s">${{parameters.storageAccount}}</span><span class="nv"> </span><span class="s">--pattern</span><span class="nv"> </span><span class="s">/*'</span>

  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureCLI@1</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Upload</span><span class="nv"> </span><span class="s">files</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">storage'</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AzureSubscriptionName)'</span>
      <span class="na">scriptLocation</span><span class="pi">:</span> <span class="s">inlineScript</span>
      <span class="na">inlineScript</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">az storage blob upload-batch -d $web --account-name ${{parameters.storageAccount}} -s $(Pipeline.Workspace)/ToDosDemoClient/app/Kros.Angular.BestPractices</span>
</code></pre></div></div>

<p>V prvom kroku samozrejme mus√≠me stiahn√∫≈• artefakty. V tomto pr√≠pade z pipeline-y, ktor√∫ si prid√°me nesk√¥r a pomenujeme ju <code class="highlighter-rouge">ToDosDemoClient</code>. Angular generuje s√∫borom n√°hodne znaky, preto sk√¥r ako upload-neme nov√∫ verziu, mus√≠me vymaza≈• star√∫.</p>

<p>Na volanie Azure CLI pr√≠kazov pou≈æijeme <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops"><code class="highlighter-rouge">AzureCLI@1</code></a> task. Ktor√©mu nastav√≠me <code class="highlighter-rouge">azureSubscription</code> nad ktorou sa pr√≠kazy bud√∫ sp√∫≈°≈•a≈•. Pomocou <code class="highlighter-rouge">scriptLocation</code> oznaƒç√≠me, ≈æe script budeme p√≠sa≈• priamo v tejto ≈°abl√≥ne <em>(Ak chceme ma≈• script v samostatnom s√∫bore tak to nastav√≠me na <code class="highlighter-rouge">scriptPath</code>)</em>.</p>

<p>Pr√≠kazom <a href="https://docs.microsoft.com/en-us/cli/azure/storage/blob?view=azure-cli-latest#az-storage-blob-delete-batch"><code class="highlighter-rouge">az storage blob delete-batch</code></a> vyma≈æeme v≈°etky s√∫bory <code class="highlighter-rouge">--pattern /*</code> z kontajnera <code class="highlighter-rouge">$web</code> v Storage Account-e <code class="highlighter-rouge">--account-name ${{parameters.storageAccount}}</code>.</p>

<p>Rovnak√Ωm sp√¥sobom upload-neme aj nov√© s√∫bory z artefaktov umiestnen√Ωch v <code class="highlighter-rouge">$(Pipeline.Workspace)/ToDosDemoClient/app/Kros.Angular.BestPractices</code>. Na upload s√∫borov do Blob Storage je mo≈æn√© pou≈æi≈• aj <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-file-copy?view=azure-devops"><code class="highlighter-rouge">AzureFileCopy@3</code></a> task, bohu≈æiaƒæ tento neakceptuje nastaven√∫ syt√©movu proxy a preto na on-premise serveroch s t√Ωm b√Ωva probl√©m.</p>

<p>≈†abl√≥nu pou≈æijeme v na≈°ej pipeline.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">trigger</span><span class="pi">:</span> <span class="s">none</span>

<span class="na">resources</span><span class="pi">:</span>
  <span class="na">pipelines</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">pipeline</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">Build - Demo - CI</span>
    <span class="na">trigger</span><span class="pi">:</span> <span class="no">true</span>

  <span class="pi">-</span> <span class="na">pipeline</span><span class="pi">:</span> <span class="s">ToDosDemoClient</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">Build - Angular - CI</span>
    <span class="na">trigger</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">variables</span><span class="pi">:</span>
  <span class="na">AzureSubscriptionName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Demo</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">Subscription'</span>
  <span class="na">ResourceGoupName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mino-demo-rsg'</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Tests'</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">SlotName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Services</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Testing</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
            <span class="na">artifact</span><span class="pi">:</span> <span class="s">drop</span>
            <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">artifacts'</span>

          <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">deploy-microservice.yml</span>
            <span class="na">parameters</span><span class="pi">:</span>
              <span class="na">microservices</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">ToDos'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">Authorization'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">Organizations'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">ApiGateway'</span><span class="pi">]</span>

  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Client</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Testing</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">deploy-client.yml</span>
            <span class="na">parameters</span><span class="pi">:</span>
              <span class="na">storageAccount</span><span class="pi">:</span> <span class="s1">'</span><span class="s">minodemostorage'</span>
</code></pre></div></div>

<p>Definujeme si odkaz na pipeline-u, ktor√° build-uje na≈°u Angular aplik√°ciu:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">pipeline</span><span class="pi">:</span> <span class="s">ToDosDemoClient</span>
  <span class="na">source</span><span class="pi">:</span> <span class="s">Build - Angular - CI</span>
  <span class="na">trigger</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>Nasadenie klienta m√¥≈æme vykona≈• paralelne s nasadzovan√≠m backend-u, preto prid√°me ƒèal≈°√≠ job <code class="highlighter-rouge">- deployment: Client</code>. Pokiaƒæ m√°me dostatok voƒæn√Ωch agentov tak sa n√°m backend a frontend nasadia s√∫ƒçasne.</p>

<p>Takto pripraven√° pipeline-a n√°m nasadi cel√∫ na≈°u aplik√°ciu. Po nasaden√≠ n√°m v≈°ak aplik√°cia e≈°te nebude fungova≈•, preto≈æe nie je nakonfigurovan√°. <em>(Napr√≠klad ch√Ωba connection string na datab√°zu.)</em> To ako rie≈°i≈• konfigur√°ciu syst√©mu v Azure prostred√≠ je mimo z√°ber tohto ƒçl√°nku. Budem sa tomu venova≈• nesk√¥r.</p>

<p>V tomto kroku by sa patrilo e≈°te spusti≈• UI testy. My na to vyu≈æ√≠vame <a href="https://www.cypress.io/">cypress</a>. V ƒèal≈°om ƒçl√°nku si uk√°≈æeme ako spusti≈• postman aj cypress testy.</p>

<h3 id="swap-do-produkcie">Swap do produkcie</h3>

<p>Po otestovan√≠ aplik√°cie v testovacom prostred√≠ by sme chceli aplik√°ciu nasadi≈• do produkcie. V tejto ƒçasti si uk√°≈æeme ako na to vyu≈æi≈• swapovanie. Swap-ovanie n√°m umo≈æn√≠ vyu≈æi≈• to, ≈æe na≈°a aplik√°cia je v teste u≈æ ‚Äúzahriata‚Äù a t√Ωm sa vyhneme studen√©mu ≈°tartu. Taktie≈æ n√°m to umo≈æn√≠ spravi≈• bezodst√°vkov√© nasadzovanie.</p>

<p>Swap-nutie si definujeme v ≈°ablone <code class="highlighter-rouge">deploy-swap.yml</code>.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">microservices</span><span class="pi">:</span> <span class="pi">[]</span>

<span class="na">steps</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">${{ each microservice in parameters.microservices }}</span><span class="err">:</span> <span class="c1"># Each microservice</span>
  <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureAppServiceManage@0</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Swap</span><span class="nv"> </span><span class="s">Slots:</span><span class="nv"> </span><span class="s">mino-demo-${{microservice}}-api'</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s">$(AzureSubscriptionName)</span>
      <span class="na">WebAppName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mino-demo-${{microservice}}-api'</span>
      <span class="na">ResourceGroupName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(ResourceGoupName)'</span>
      <span class="na">SourceSlot</span><span class="pi">:</span> <span class="s">$(SlotName)</span>
</code></pre></div></div>

<p>Pomocou task-u <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-app-service-manage?view=azure-devops">AzureAppServiceManage@0</a> dok√°≈æeme mene≈æova≈• Azure Web Apps. To ƒço s danou slu≈æbou chceme urobi≈• urƒç√≠me nastaven√≠m vlastnosti <code class="highlighter-rouge">action</code>. V na≈°om pr√≠pade ju ale neuv√°dzame, preto≈æe default hodnota je pr√°ve <code class="highlighter-rouge">Swap Slots</code>, ƒço chceme.</p>

<p>Cel√° deploy pipeline-a m√¥≈æe vyzera≈• nasledovne:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">trigger</span><span class="pi">:</span> <span class="s">none</span>

<span class="na">resources</span><span class="pi">:</span>
  <span class="na">pipelines</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">pipeline</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">Build - Demo - CI</span>
    <span class="na">trigger</span><span class="pi">:</span> <span class="no">true</span>

  <span class="pi">-</span> <span class="na">pipeline</span><span class="pi">:</span> <span class="s">ToDosDemoClient</span>
    <span class="na">source</span><span class="pi">:</span> <span class="s">Build - Angular - CI</span>
    <span class="na">trigger</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">variables</span><span class="pi">:</span>
  <span class="na">AzureSubscriptionName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Demo</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">Subscription'</span>
  <span class="na">ResourceGoupName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">mino-demo-rsg'</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Tests'</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">SlotName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Testing'</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Services</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Testing</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">ToDosDemoServices</span>
            <span class="na">artifact</span><span class="pi">:</span> <span class="s">drop</span>
            <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">artifacts'</span>

          <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">deploy-microservice.yml</span>
            <span class="na">parameters</span><span class="pi">:</span>
              <span class="na">microservices</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">ToDos'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">Authorization'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">Organizations'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">ApiGateway'</span><span class="pi">]</span>

  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Client</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Testing</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">deploy-client.yml</span>
            <span class="na">parameters</span><span class="pi">:</span>
              <span class="na">storageAccount</span><span class="pi">:</span> <span class="s1">'</span><span class="s">minodemostorage'</span>

<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Production'</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Production'</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">Services</span>
    <span class="na">pool</span><span class="pi">:</span>
      <span class="na">vmImage</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Production</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">runOnce</span><span class="pi">:</span>
        <span class="na">deploy</span><span class="pi">:</span>
          <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">deploy-swap.yml</span>
            <span class="na">parameters</span><span class="pi">:</span>
              <span class="na">microservices</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">ToDos'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">Authorization'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">Organizations'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">ApiGateway'</span><span class="pi">]</span>
</code></pre></div></div>

<p>M√°me hotov√∫ pipelinu-u, ktor√° n√°m nasad√≠ na≈°e slu≈æby do testu a n√°sledne hneƒè do produkcie. M√°lokto z n√°s m√° cel√Ω proces nasadzovania a automatick√Ωch testov dotiahnut√Ω tak ƒèaleko, aby po commit-e do master vetvy mohol necha≈• automaticky zbehnu≈• nasadenie a≈æ do produkcie. V√§ƒç≈°inou chceme pred nasaden√≠m do produkcie nejak√Ω proces schvaƒæovania. Pri Azure Multi Stage Pipelines na to m√¥≈æeme vyu≈æi≈• <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/approvals?view=azure-devops&amp;tabs=check-pass">Environments approvals</a>. Pri ka≈ædom stage-y sme definovali vlastnos≈• <code class="highlighter-rouge">environment:</code> buƒèto ako <code class="highlighter-rouge">Testing</code>, alebo <code class="highlighter-rouge">Production</code>. Azure DevOps rob√≠ audit nad t√Ωmtito prostrediami a v≈°etko ƒço sa nasadzuje potom m√¥≈æme vidie≈• pekne prehƒæadne po jednoliv√Ωch prostrediach.</p>

<p><img src="/assets/images/multi-stage-pipelines/environments.png" alt="environment" /></p>

<p>Nad dan√Ωm prostred√≠m vieme vyn√∫ti≈• schvaƒæovanie. Dan√Ω stage sa potom zaƒçne vykon√°va≈• a≈æ po schv√°len√≠ definovan√Ωmi osobami.</p>

<p><img src="/assets/images/multi-stage-pipelines/approvals1.png" alt="approvals" /></p>

<p>Pomocou ƒèal≈°√≠ch mo≈ænost√≠ ako napr√≠klad Azure Functions / REST API / ‚Ä¶ vieme docieli≈• aj komplikovanej≈°ie / automatizovanej≈°ie scen√°re. Napr√≠klad over√≠te ƒçi vo va≈°om issue tracker-y nie je evidovan√° nejak√° chyba, ktor√° by mohla br√°ni≈• nasadeniu.</p>

<h3 id="sum√°r">Sum√°r</h3>

<p>Na rozdiel od klasick√©mu (UI) definovania CI / CD procesu n√°m Azure Multi Stages Pipelines umo≈æ≈àuj√∫ definova≈• tento proces ako k√≥d a stara≈• sa o neho ako o k√≥d. To n√°m d√°va v√Ωhodu verzionovania / proces schvaƒæovania pomocou Pull Request-ov / prehƒæadnos≈• / ‚Ä¶ Dok√°≈æeme pomocou toho jednoducho spravi≈• proces nasadzovania jednoduch√Ωch aplik√°ci√≠, ale aj zlo≈æit√© scen√°re, ktor√© si vy≈æaduj√∫ komplexn√© syst√©my.</p>

<p>Azure Multi Stages pipelines s√∫ s√≠ce e≈°te ako preview, ale u≈æ v s√∫ƒçasnosti sa daj√∫ plnohodnotne pou≈æ√≠va≈• na v√§ƒç≈°inu scen√°rov. Microsoft do toho investuje nemal√© √∫silie, ƒço je vidie≈• aj z <a href="https://docs.microsoft.com/en-us/azure/devops/release-notes/features-timeline">Azure DevOps Roadmap-y</a> pre najbli≈æ≈°ie obdobje.</p>

<h3 id="ƒço-ƒèalej">ƒåo ƒèalej?</h3>

<p>V najbli≈æej dobe by som sa s Vami chcel e≈°te podeli≈• o nasnedovn√© t√©my v danej oblasti:</p>

<ol>
  <li>Asynchr√≥nne nasadzovanie slu≈æieb</li>
  <li>Sp√∫≈°≈•anie ‚Äúpost deploy‚Äù testov</li>
</ol>

    </div>

    <div class="carousel">
        
    </div>

    <a class="u-url" href="/2020/02/23/azure-multi-stage-pipelines" hidden></a>

</article>

            <script data-name="BMC-Widget" data-cfasync="false" 
                src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" 
                data-id="minomartiniak" 
                data-description="Support me on Buy me a coffee!" 
                data-message="" 
                data-color="#00BF63" data-position="Right" 
                data-x_margin="25" 
                data-y_margin="50">
            </script>
        </div>
    </main><footer class="footer">
  <span>
    &copy; <time datetime="2025-02-19 05:37:39 +0000">2025</time> Milan Martiniak
    <a rel="me" href="https://github.com/burgyn"
      title="GitHub - burgyn">
      <span class="fa fa-github" aria-label="GitHub"></span>
    </a>
    <a rel="me" href="https://twitter.com/minomartiniak"
      title="Twitter - minomartiniak">
      <span class="fa fa-twitter" aria-label="Twitter"></span>
    </a>
    <a rel="me" href="https://linkedin.com/in/milanmartiniak" title="LinkedIn - Milan Martiniak">
      <span class="fa fa-linkedin" aria-label="LinkedIn"></span>
    </a>

    <a rel="me" href="https://blog.burgyn.online/feed.xml" title="RSS feed">
      <span class="fa fa-rss" aria-label="RSS"></span>
    </a>
  </span>
</footer><script type="text/javascript">
        $(document).ready(function () {
            $('.carousel').slick({
                dots: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                centerMode: false,
                focusOnSelect: true,
                infinite: false,
                adaptiveHeight: true
            });
        });

        lightbox.option({
            'resizeDuration': 50,
            'wrapAround': false,
            'fadeDuration': 50,
            'imageFadeDuration': 50,
            'resizeDuration': 50            
        })

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>

</html>