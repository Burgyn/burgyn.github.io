<!DOCTYPE html>
<html lang="en" class="colors theme-dark-2 entities fonts code-style"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">

    <!-- cache -->
    <meta http-equiv="Cache-Control" content="max-age=86400, must-revalidate" />    

    <!-- Pridanie Slick Carousel CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <!-- Pridanie Slick Carousel Theme CSS (voliteľné) -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <!-- Pridanie jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Pridanie Lightbox CSS a JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox-plus-jquery.min.js"></script>
    <!-- Pridanie Slick Carousel JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

    <!-- IMPORTANT -->
    <script src="https://use.fontawesome.com/ee196462b9.js"></script>

    <!-- keywoards -->
    

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FYN9BGS01R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FYN9BGS01R');
    </script>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Azure Service Bus - Ako sme nepoužili Topic filters | Burgyn’s blog</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Azure Service Bus - Ako sme nepoužili Topic filters" />
<meta name="author" content="Milan Martiniak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Pri vývoji mikroslužieb pravdepodobne narazíte na potrebu message broker-u. Spoľahlivému systému na posielanie správ medzi službami." />
<meta property="og:description" content="Pri vývoji mikroslužieb pravdepodobne narazíte na potrebu message broker-u. Spoľahlivému systému na posielanie správ medzi službami." />
<link rel="canonical" href="https://blog.burgyn.online/2022/11/07/azure-service-bus-ako-sme-nepou%C5%BEili-topic-filters" />
<meta property="og:url" content="https://blog.burgyn.online/2022/11/07/azure-service-bus-ako-sme-nepou%C5%BEili-topic-filters" />
<meta property="og:site_name" content="Burgyn’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-11-07T05:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Azure Service Bus - Ako sme nepoužili Topic filters" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Milan Martiniak","url":"https://burgyn.bio.link/"},"dateModified":"2022-11-07T05:00:00+00:00","datePublished":"2022-11-07T05:00:00+00:00","description":"Pri vývoji mikroslužieb pravdepodobne narazíte na potrebu message broker-u. Spoľahlivému systému na posielanie správ medzi službami.","headline":"Azure Service Bus - Ako sme nepoužili Topic filters","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.burgyn.online/2022/11/07/azure-service-bus-ako-sme-nepou%C5%BEili-topic-filters"},"url":"https://blog.burgyn.online/2022/11/07/azure-service-bus-ako-sme-nepou%C5%BEili-topic-filters"}</script>
<!-- End Jekyll SEO tag -->


    


    <!-- CSS -->
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-192x192" type="image/png" sizes="192x192" href="/assets/android-chrome-192x192.png">
    <link rel="android-chrome-512x512" type="image/png" sizes="512x512" href="/assets/android-chrome-512x512.png">

    <!-- PWA -->
    <link rel="manifest" href="/assets/manifest.json">

    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="https://blog.burgyn.online/feed.xml" title="Burgyn's blog" />

    <!-- Google Analytics-->
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'dark'
        });
    </script>
</head><body>
    <svg width="0" height="0">
        <defs>
            <marker id="custom-arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
            <path d="M0,0 L0,7 L10,3.5 z"></path>
            </marker>
        </defs>
    </svg>
    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <div class="site-name">
        <img src="/assets/android-chrome-192x192.png" alt="Burgyn's logo" class="nav-logo">
        <h2 class="nav-title">Burgyn's blog</h2>
      </div>
    </a>    
    <ul>
      <li><a href="/">Posts</a></li>
      <li><a href="/about/">About me</a></li>
    </ul>
  </div>
</nav>

    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline"><p>Azure Service Bus - Ako sme nepoužili Topic filters</p>
</h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2022-11-07T05:00:00+00:00" itemprop="datePublished">Nov 7, 2022
            </time><span itemprop="author" itemscope
                itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name"> | Milan Martiniak</span></span>
            | <span class="fa fa-tags" aria-label="Tags"> </span> 
            <span>
                <!-- <a href="/tags/AZURE">AZURE</a> -->
                AZURE
            </span>  
        </p>
    </header>

    

    <div class="post-content e-content" itemprop="articleBody">
        <p>Pri vývoji mikroslužieb pravdepodobne narazíte na potrebu message broker-u. Spoľahlivému systému na posielanie správ medzi službami.</p>

<p>My v KROS a.s. sme sa rozhodli na tento účel použiť Azure Service Bus, ktorý v rámci vytvoreného namespaces ponúka takzvané topiky, ku ktorým môžete mať viacero subscriberov.</p>

<p>V poslednom období sme chceli využiť jeho funkcionalitu <a href="https://learn.microsoft.com/en-us/azure/service-bus-messaging/topic-filters">Topic filtes</a>. Tá umožňuje, že na jednotlivých subscriptions pre daný topik môžete mať takzvaný filter, alebo pravidlo, ktoré rozhodne či správa bude doručená danému subskriberovi.</p>

<p>My sme to chceli použiť na náš use case s indexovaním do searchu. Pri zmene doménových entít v naších službách posielame správu o zmene entity. Posielame informácie o type entity a zmenené vlastnosti. Azure funkcia tieto správy odchytáva a zabezpečuje indexovanie zmien do nášho full text search-u. Chceli sme si to zautomatizovať a preto máme celý mechanizmus v base triedach. V našom prípade bolo najjednoduchšie posielať správy o zmene do jedného spoločného topiku, ale zároveň sme chceli aby na každý typ entity bol samostatný subscriber. Topic filters nám prišiel na to ideálny. Z pohľadu návrhu sa nám to páčilo, publisher posiela do jedného topiku a viac sa nezaujíma. Subscriber dostane takú správu ako očakáva a správne doručenie zabezpečí logika na strane infraštruktúry.</p>

<p>Prišlo však jedno ale! A to v podobe throttlingu. My využívame Azure Service Bus v Standard tier. Ten podľa <a href="https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-throttling">dokumentácia</a> využíva zdieľané zdroje. Aby Azure zabezpečil spravodlivé využitie zdrojov naprieč všetkými namespaces, ktoré používajú rovnaké prostredie, používa throttling založený na kreditnom systéme. Tento systém obmedzuje počet operácií, ktoré môžu byť vykonané v danom čase.</p>

<p>Na začiatok tohto časového obdobia (aktuálne jedna sekunda) pridelí Azure určitý počet kreditov <em>(aktuálne <code class="highlighter-rouge">1000</code>. Teda <code class="highlighter-rouge">1000 credits per second</code>).</em> Ak sa kredity minú, tak ďalšie operácie v danom časovom intervale budú throttled až do ďalšieho časového obdobia. Kredity sú doplnené po uplynutí časového obdobia.</p>

<p>Základné dátové operácie (<code class="highlighter-rouge">Send</code>, <code class="highlighter-rouge">Receive</code>, <code class="highlighter-rouge">Peek</code> a ich <code class="highlighter-rouge">async</code> verzie) sú spoplatnené jedným kreditom.</p>

<p>Plus je v dokumentácií jedna dôležitá poznámka:</p>

<blockquote>
  <p>ℹ️ Note
Please note that when sending to a Topic, each message is evaluated against filter(s) before being made available on the Subscription. Each filter evaluation also counts against the credit limit (i.e. 1 credit per filter evaluation).</p>
</blockquote>

<p>&lt;/aside&gt;</p>

<p>Čiže vyhodnotenie každého filtra je spoplatnené jedným kreditom.</p>

<p>No a tu prichádza naša matematika. Pre daný topic sme mali 56 subscriberov a tým pádom 56 filtrov. Pri už relatívne nízkej záťaži 20 zmien na entitách za sekundu by sme potrebovali <strong>1 160 kreditov. <code class="highlighter-rouge">20 (odoslanie) + 20*56 (vyhodnotenie filtrov) + 20 (prijatie) = 1 160</code></strong> Čiže 160 operácií bolo throttlovaných ☹️.</p>

<h2 id="možné-riešenia">Možné riešenia?</h2>

<h3 id="prejsť-na-premium-tier">Prejsť na Premium tier</h3>

<p>Premium tier je na dedikovaných zdrojoch a throttling tu nie je aplikovaný. Bohužiaľ je tu veľký rozdiel v cene. Pri aktuálnom Standard tier platíme mesačne zhruba 11€ / mesiac, pri Premium tier by to bolo cez 700€ / mesiac.</p>

<p>Nehovorím, že na Premium tier neprejdeme, ale aktuálne je to navýšenie ceny príliš vysoké voči tomu čo od toho potrebujeme.</p>

<h3 id="samostatný-topic-pre-každú-entity">Samostatný topic pre každú entity</h3>

<p>Pri odosielaní budeme mať pre každú entitu samostatný topic. Výsledna spotreba kreditov by bola 40 kreditov <code class="highlighter-rouge">20 (odoslanie) + 20 (prijatie) = 40</code> .</p>

<p>Nevýhoda, publisher sa musí rozhodovať, do ktorého topicu má danú správu odoslať.</p>

<h3 id="jeden-topic-jedna-subscription">Jeden topic jedna subscription</h3>

<p>Odosielať sa bude do jedného topic. Bude jeden subscriber, ktorý sa v tele metódy bude musieť rozhodovať čo s danou správou vykoná.</p>

<p>Výsledná spotreba kreditov by bola 40 kreditov <code class="highlighter-rouge">20 (odoslanie) + 20 (prijatie) = 40</code> .</p>

<p>Nevýhoda, subscriber sa musí rozhodovať čo má s danou správou spraviť.</p>

<h2 id="čo-sme-vybrali">Čo sme vybrali?</h2>

<p>Rozhodli sme sa ísť cestou jedného subscribera. Je to v našom kontexte lepšie riešenie ako mať topic per entitu.</p>

    </div>

    <div class="carousel">
        
    </div>

    <a class="u-url" href="/2022/11/07/azure-service-bus-ako-sme-nepou%C5%BEili-topic-filters" hidden></a>

</article>

            <script data-name="BMC-Widget" data-cfasync="false" 
                src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" 
                data-id="minomartiniak" 
                data-description="Support me on Buy me a coffee!" 
                data-message="" 
                data-color="#00BF63" data-position="Right" 
                data-x_margin="25" 
                data-y_margin="50">
            </script>
        </div>
    </main><footer class="footer">
  <span>
    &copy; <time datetime="2025-02-19 05:37:39 +0000">2025</time> Milan Martiniak
    <a rel="me" href="https://github.com/burgyn"
      title="GitHub - burgyn">
      <span class="fa fa-github" aria-label="GitHub"></span>
    </a>
    <a rel="me" href="https://twitter.com/minomartiniak"
      title="Twitter - minomartiniak">
      <span class="fa fa-twitter" aria-label="Twitter"></span>
    </a>
    <a rel="me" href="https://linkedin.com/in/milanmartiniak" title="LinkedIn - Milan Martiniak">
      <span class="fa fa-linkedin" aria-label="LinkedIn"></span>
    </a>

    <a rel="me" href="https://blog.burgyn.online/feed.xml" title="RSS feed">
      <span class="fa fa-rss" aria-label="RSS"></span>
    </a>
  </span>
</footer><script type="text/javascript">
        $(document).ready(function () {
            $('.carousel').slick({
                dots: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                centerMode: false,
                focusOnSelect: true,
                infinite: false,
                adaptiveHeight: true
            });
        });

        lightbox.option({
            'resizeDuration': 50,
            'wrapAround': false,
            'fadeDuration': 50,
            'imageFadeDuration': 50,
            'resizeDuration': 50            
        })

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>

</html>